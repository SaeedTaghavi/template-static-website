define(["backbone","underscore","js/mixins/add_stable_index_to_collection"],function(t,e,n){var i=t.Model.extend({defaults:function(){return{abstract:void 0,title:void 0,authorAff:void 0,pub:void 0,pubdate:void 0,keywords:void 0,bibcode:void 0,pub_raw:void 0,doi:void 0,details:void 0,links_data:void 0,resultsIndex:void 0,visible:!1,actionsVisible:!0,showCheckbox:!0}},idAttribute:"resultsIndex"}),s=t.Collection.extend({initialize:function(t,e){this.numVisible=0,this.currentStartIndex=0,this.currentEndIndex=0,this.lastIndex=-1,this.lastMissingTrigger=null,e&&e.paginationModel&&(this.paginationModel=e.paginationModel,this.listenTo(this.paginationModel,"change:page",this._onPaginationChange),this.listenTo(this.paginationModel,"change:perPage",this._onPaginationChange))},model:i,numFound:void 0,comparator:"resultsIndex",_updateStartAndEndIndex:function(){var t=this.paginationModel.get("page"),e=this.paginationModel.get("perPage"),n=this.paginationModel.get("numFound");this.currentStartIndex=this.getPageStart(t,e),this.currentEndIndex=this.getPageEnd(t,e,n)},_onPaginationChange:function(){this._updateStartAndEndIndex(),this.trigger("pagination:change")},reset:function(){this.lastMissingTrigger=null,this.lastIndex=-1,t.Collection.prototype.reset.apply(this,arguments)},getStartIndex:function(){return this.currentStartIndex},getEndIndex:function(){return this.paginationModel.get("perPage")},_incrementLastIndex:function(){return this.lastIndex+=1,this.lastIndex},_prepareModel:function(e,n){return void 0===e.resultsIndex&&(e.resultsIndex=this._incrementLastIndex()),(e.title||e.bibcode||e.identifier)&&(e.emptyPlaceholder=!1),t.Collection.prototype._prepareModel.call(this,e,n)},getVisibleModels:function(){return e.filter(this.models,function(t){return t.attributes.visible})},updateIndexes:function(t,n,i){i=i||{};t=e.isNumber(t)?t:this.currentStartIndex,n=e.isNumber(n)?n:this.currentEndIndex+1;var s,r=0,o=null,a=0,d=[],l=null;if(this.each(function(i){s=i.attributes.resultsIndex,null!==l&&s!=l+1&&e.each(e.range(l+1,s),function(t){d.push(t)}),l=s,s>=t&&s<=n?(i.set("visible",!0),null===o&&(o=s),r+=1,a=s):i.set("visible",!1)}),r!==n-t+1&&e.each(e.range((l||t+d.length)+1,n+1),function(t){this.get(t)||d.push(t)},this),d.length){for(var u=0,h=d.length,g=0;g<d.length;g++){if(d[g]>n){h=g;break}d[g]<t&&(u=g+1)}d=d.slice(u,h),d=this._compressGaps(d),JSON.stringify(d)!=this.lastMissingTrigger&&(this.lastMissingTrigger=JSON.stringify(d),i.silent||this.trigger("show:missing",d))}return this.numVisible=r,this.currentStartIndex=o||0,this.currentEndIndex=a,r},_compressGaps:function(t){for(var e=t[0],n=e,i=t.length,s=[],r=0;r<i;r++){for(var o=r+1;o<i&&t[o]==e+(o-r);)n=t[o],o+=1;s.push({start:e,end:n}),r=o-1,o<i&&(e=n=t[o])}return s},showRange:function(t,e,n){if(n=n||{},t<0)throw new Error("Start cannot be negative");if(e<t)throw new Error("End cannot be smaller than start");return this.updateIndexes(t,e,n)},getNumVisible:function(){return this.numVisible},showMore:function(t){if(null===t)return this.updateIndexes(0,this.model.length);var e=this.getNumVisible();return this.updateIndexes(this.currentStartIndex,0==this.currentEndIndex?t-1:this.currentEndIndex+t)-e}});return e.extend(s.prototype,n),s});