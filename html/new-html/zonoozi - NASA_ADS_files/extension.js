define(["underscore","js/components/api_query","js/components/api_request","js/components/api_query_updater","js/components/api_targets","js/modules/orcid/work","js/components/api_feedback","js/mixins/dependon"],function(e,t,i,o,n,r,d){return function(d){var c=new o("OrcidExtension"),a=d.prototype.processDocs,s=d.prototype.activate,l=d.prototype.onAllInternalEvents;return d.prototype.activate=function(t){this.setBeeHive(t),s.apply(this,arguments);var i=t.hasService("PubSub")&&t.getService("PubSub");i.subscribe(i.CUSTOM_EVENT,e.bind(this.onCustomEvent))},d.prototype.onCustomEvent=function(t,i){var o=e.bind(function(t,i){var o=e.filter(this.collection.models,function(t){return e.contains(i,t.get("bibcode"))});e.forEach(o,e.bind(function(i){var o=e.map(i.get("orcid").actions,"action");if(e.contains(o,t)){var n=this.view.children.findByModel(i);n&&n.trigger("OrcidAction",{action:t,view:n,model:i})}},this))},this);switch(t){case"orcid-bulk-claim":o("orcid-add",i);break;case"orcid-bulk-update":o("orcid-update",i);break;case"orcid-bulk-delete":o("orcid-delete",i)}},d.prototype._getOrcidInfo=e.memoize(function(e){var t={actions:{},provenance:null};return e.isCreatedByOthers&&e.isCreatedByADS?(t.actions.update={title:"update in ORCID",caption:"Update ADS version with latest data",action:"orcid-update"},t.actions.delete={title:"delete from ORCID",caption:"Delete ADS version from ORCID",action:"orcid-delete"},t.actions.view={title:"view in ORCID",caption:"Another version exists (we don't have rights to update it)",action:"orcid-view"}):e.isCreatedByOthers&&!e.isCreatedByADS?(e.isKnownToADS&&(t.actions.add={title:"add ADS version ORCID",caption:"ORCID already has a record for this article (we don't have rights to update it).",action:"orcid-add"}),t.actions.view={title:"view in ORCID",caption:"Another version exists (we don't have rights to update it)",action:"orcid-view"}):!e.isCreatedByOthers&&e.isCreatedByADS?(t.actions.update={title:"update in ORCID",caption:"Update ADS version with latest data",action:"orcid-update"},t.actions.delete={title:"delete from ORCID",caption:"Delete ADS version from ORCID",action:"orcid-delete"}):t.actions.add={title:"add to ORCID",caption:"Add ADS version to ORCID",action:"orcid-add"},e.isCreatedByADS&&e.isCreatedByOthers?t.provenance="ads":e.isCreatedByADS?t.provenance="ads":e.isCreatedByOthers?t.provenance="others":t.provenance=null,t},function(e){return[e.isCreatedByADS,e.isCreatedByOthers,e.isKnownToADS,e.provenance]}),d.prototype._setDocsToPending=function(t,i){e.forEach(t,function(t){var o=!e.isBoolean(i)||i;t.orcid=e.extend({},t.orcid,{pending:o})})},d.prototype.addOrcidInfo=function(t){var i=this,o=!1,n=e.noop,r=this.getBeeHive().getService("OrcidApi");if(!r||!r.hasAccess())return t;var d=e.debounce(function(){e.forEach(i.hiddenCollection.models,function(t){var i=t.get("orcid");i.pending&&(i=e.extend({},i,{pending:!1,error:"Error while applying Orcid Data"}),t.set("orcid",i))})},100),c=(e.debounce(function(){var t=i._getOrcidInfo({});e.forEach(i.hiddenCollection.models,function(e){e.get("orcid")&&e.get("orcid").pending&&e.set("orcid",t)})},100),function t(o,n){e.forEach(e.rest(arguments),function(r,d){var c=o[d],a=i._getOrcidInfo(r);r.sourcedByADS&&e.isUndefined(c.source_name)&&(c.source_name="NASA Astrophysics Data System"),c.orcid=e.extend({},c.orcid,a,{pending:!1}),e.isUndefined(c.identifier)&&(c.identifier=c._work.getIdentifier());var s,l=e.find(i.hiddenCollection.models,function(t){return e.isPlainObject(c._work)&&c._work===t.get("_work")||!e.isUndefined(c.identifier)&&c.identifier===t.get("identifier")});l?(e.isPlainObject(c._work)&&(s=c._work.getSources()),e.isUndefined(l.get("identifier"))&&i.orcidWidget&&l.set("identifier",c.identifier),l.set({orcid:a,source_name:e.isArray(s)?s.join("; "):l.get("source_name")})):n<60&&e.delay(e.bind(t,i,[c],n+1),500);e.isArray(r.children)&&e.forEach(r.children,function(t){var o=e.find(i.hiddenCollection.models,function(i){return e.isString(t)&&t===i.get("_work").getPutCode()});o&&i.removeModel(o)})})}),a=function(t){return o?e.defer(d):(o=!0,n(t))};return(n=function(t){var o=e.map(t,function(t){return r.getRecordInfo(t).done(function(o){o.sourcedByADS&&e.isUndefined(t.source_name)&&(t.source_name="NASA Astrophysics Data System"),t.orcid=e.extend({},t.orcid,i._getOrcidInfo(o),{pending:!1})})});i._setDocsToPending(t),$.when.apply($,o).then(e.partial(c,t),e.partial(a,t))})(t),t},d.prototype._paginationUpdate=function(){var t=this;e.forEach(this.hiddenCollection.models,function(i){var o=e.find(t.collection.models,function(e){return e.get("_work")===i.get("_work")});o&&o.get("orcid").pending&&o.set("orcid",i.get("orcid"))})},d.prototype._updateModelsWithOrcid=function(t,i){var o=e.filter(t||this.hiddenCollection.models,function(e){return!e.has("_work")&&e.has("identifier")});e.isEmpty(o)?i<60&&e.delay(e.bind(self._updateModelsWithOrcid,self,null,i+1),500):this.getBeeHive().getService("OrcidApi").getUserProfile().done(function(t){var n=t.getWorks();e.forEach(o,function(t){var o=e.flatten(e.values(e.pick(t.attributes,["identifier"])));e.forEach(n,function(n){var r=e.flatten(e.values(n.getIdentifier()));e.intersection(o,r).length>0?t.set({source_name:n.getSources().join("; "),_work:n}):i<60&&e.delay(e.bind(self._updateModelsWithOrcid,self,[t],i+1),500)})})})},d.prototype.processDocs=function(t,i,o){i=a.apply(this,arguments);var n=this.getBeeHive().getObject("User");if(n&&n.isOrcidModeOn()||this.orcidWidget){var r=t.get("responseHeader.params"),d=parseInt(r.start)+parseInt(r.rows),c=this.addOrcidInfo(i,d);return o.numFound!==c.length&&e.extend(o,this.getPaginationInfo(t,i)),e.delay(e.bind(this._updateModelsWithOrcid,this,0),1e3),c}return i},d.prototype.mergeADSAndOrcidData=function(o){var d=this,a=$.Deferred(),s=d.getBeeHive().getService("OrcidApi"),l=function(t,i){var n=i.response&&i.response.docs&&i.response.docs[0],d=(t=new r(t._root,!0)).toADSFormat();d=e.isPlainObject(d)?d:{},n=e.isPlainObject(n)?n:{},o.set(e.extend({},o.attributes,d,n)),a.resolve(o)},u=function(){a.reject.apply(a,arguments)},p=function(){a.reject.apply(a,arguments)},f=function(r){var a=o.get("identifier"),s=new t({q:"identifier:"+c.quoteIfNecessary(a),fl:"title,abstract,bibcode,author,pub,pubdate,doi,doctype"}),p=new i({query:s,target:n.SEARCH,options:{done:e.partial(l,r),fail:u}}),f=d.getPubSub();f.publish(f.EXECUTE_REQUEST,p)},g=o.get("_work");return g?s.getWork(g.getPutCode()).done(f).fail(p):this._findWorkByModel(o).done(function(e){s.getWork(e.getPutCode()).done(f).fail(p)}).fail(p),a.promise()},d.prototype._findWorkByModel=function(t,i){var o=$.Deferred(),n=this.getBeeHive().getService("OrcidApi"),d=e.pick(t.attributes,["identifier"]),c=e.pick(t.attributes,["all_ids"]),a=e.clone(t.get("orcid")||{}),s=null;e.isUndefined(i)&&(s=n.getUserProfile());var l=function(i){var s=i.getWorks(),l=!0,u=null,p=e.find(s,function(t){var i=t.getIdentifier();return l=d.identifier===i,u=t.getPutCode(),e.contains(c.all_ids,i)});if(p){if(!l){var f=r.adsToOrcid(t.attributes,u);n.updateWork(f)}o.resolve(p)}else{o.reject();var g="Could not find a matching ORCiD Record";console.error.apply(console,[g].concat(arguments)),t.set("orcid",e.extend(a,{pending:!1,error:g}))}};return e.isUndefined(i)?(s.done(l),s.fail(function(){o.reject.apply(o,arguments);var i="Error retrieving ORCiD profile";console.error.apply(console,[i].concat(arguments)),t.set("orcid",e.extend(a,{pending:!1,error:i}))})):l(i),o.promise()},d.prototype.removeModel=function(t){var i=t.resultsIndex;this.hiddenCollection.remove(t);var o=this.hiddenCollection.models;e.forEach(e.rest(o,i),function(e){e.set("resultsIndex",e.get("resultsIndex")-1),e.set("indexToShow",e.get("indexToShow")-1)});var n=this.model.get("showRange"),r=e.range(n[0],n[1]+1),d=[];e.forEach(r,function(e){o[e]&&o[e].set&&(o[e].set("visible",!0),o[e].resultsIndex=e,o[e].set("resultsIndex",e),o[e].set("indexToShow",e+1),d.push(o[e]))}),this.hiddenCollection.reset(o),this.collection.reset(d),this.model.set("totalPapers",o.length)},d.prototype.onAllInternalEvents=function(t,i,o){if("childview:OrcidAction"===t){var n=this,d=o.action,c=this.getBeeHive().getService("OrcidApi"),a=e.clone(o.model.get("orcid")||{}),s=this.getPubSub();s.publish(s.CUSTOM_EVENT,"orcid-action",d);var u={"orcid-add":function(t){t.set("orcid",{pending:!0});var i,o=function(){n._findWorkByModel(t).done(function(e){t.set({orcid:n._getOrcidInfo({isCreatedByADS:!0,isCreatedByOthers:!1,isKnownToADS:!0,provenance:"ads"}),source_name:e.getSources().join("; ")}),n.trigger("orcidAction:"+d,t)})},s=r.adsToOrcid(t.attributes);if(s)i=s,c.addWork(i).done(o).fail(function(i,n,r){if("CONFLICT"===r)return o();var d="Failed to add entry, please try again";console.error.apply(console,[d].concat(arguments)),t.set("orcid",e.extend(a,{pending:!1,error:d}))});else{var l="There was a problem adding the record, try again";console.error.apply(console,[l].concat(arguments)),t.set("orcid",e.extend(a,{pending:!1,error:l}))}},"orcid-delete":function(t){t.set("orcid",{pending:!0});var i=function(){n.orcidWidget?n.removeModel(t):t.set("orcid",n._getOrcidInfo({})),n.trigger("orcidAction:"+d,t)},o=function(o){c.deleteWork(o.getPutCode()).done(i).fail(function(o,n,r){if("NOT FOUND"===r)return i();var d="Error deleting record, please try again";console.error.apply(console,[d].concat(arguments)),t.set("orcid",e.extend(a,{pending:!1,error:d}))})},r=t.get("_work");r?o(r):n._findWorkByModel(t).done(o)},"orcid-update":function(t){t.set("orcid",{pending:!0});var i=function(){var i="Error updating record, please try again";console.error.apply(console,[i].concat(arguments)),t.set("orcid",e.extend(a,{pending:!1,error:i}))};n.mergeADSAndOrcidData(t).done(function(t){var o=t.get("_work").getPutCode(),a=r.adsToOrcid(t.attributes,o);if(e.isNull(a))return i(a);c.updateWork(a).done(function(e){var i=new r(e,!0);c.getRecordInfo(i.toADSFormat()).done(function(e){t.set("orcid",n._getOrcidInfo(e)),n.trigger("orcidAction:"+d,t)})}).fail(i),t.set(t.attributes,{silent:!0})}).fail(function(){var i="Failed to merge ORCiD and ADS data";console.error.apply(console,[i].concat(arguments)),t.set("orcid",e.extend(a,{pending:!1,error:i}))})},"orcid-login":function(){c.signIn()},"orcid-logout":function(){c.signOut()},"orcid-view":function(t){var i=t.get("orcidWorkPath");e.isString(i)&&window.open(i,"_blank").focus()}};u[d]&&u[d](o.model)}return l.apply(this,arguments)},d}});