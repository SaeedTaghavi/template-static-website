define(["./base_graph","hbs!js/widgets/facet/graph-facet/templates/year-graph-legend","marionette","jquery-ui"],function(t,e,a,r){return t.extend({bins:10,margin:{top:5,right:0,bottom:20,left:10},id:"year-graph",legendTemplate:e,formatXAxisText:function(t){t.style("text-anchor","end").attr("dx","-.8em").attr("dy","-1.1em").attr("transform",function(t){return"rotate(-65)"})},buildGraph:function(){var t,e,r,i,n,s,l,h,d=this,o=d3.format("s");t=_.clone(this.model.get("graphData")),t=this.binData(t,this.bins),e=_.pluck(t,"x"),maxVal=d3.max(_.pluck(t,"y")),r=d3.scale.ordinal().domain(e).rangeRoundBands([0,this.width],.1),i=d3.scale.linear().domain([0,maxVal]).range([this.height,0]),n=d3.svg.axis().scale(r).orient("bottom"),s=d3.svg.axis().scale(i).ticks(5).orient("left").tickFormat(function(t){return t>=1&&t%1==0?o(t):""}),l=d3.select(this.el).select(".chart").attr("width",this.fullWidth).attr("height",this.fullHeight).attr("aria-label","limit years graph"),this.innerChart=l.append("g").classed("inner-chart",!0).attr("transform","translate("+this.margin.left+","+this.margin.top+")"),(h=this.innerChart.selectAll("g").data(t).enter().append("g").classed("bar",!0).attr("transform",function(t){return"translate("+r(t.x)+",0)"})).append("rect").classed("full-bar",!0).attr("y",function(t){return i(t.y)}).attr("height",function(t){return d.height-i(t.y)}).attr("width",function(t){return r.rangeBand()*t.width/d.binSize}),h.append("rect").classed("refereed",!0).attr("y",function(t){return i(t.refCount)}).attr("height",function(t){return d.height-i(t.refCount)}).attr("width",function(t){return r.rangeBand()*t.width/d.binSize}),this.innerChart.append("g").classed({axis:!0,"x-axis":!0}).attr("transform","translate(0,"+this.height+")").call(n).selectAll("text").call(this.formatXAxisText),this.innerChart.append("g").classed({axis:!0,"y-axis":!0}).call(s).selectAll("text").style("text-anchor","start"),this.innerChart.append("text").attr("class","s-label").attr("x",this.width/2-20).attr("y",212).text(a.getOption(this,"xAxisTitle")),this.innerChart.append("text").attr("class","s-label").attr("y",-40).attr("x",-this.height/2).attr("transform","rotate(-90)").text(a.getOption(this,"yAxisTitle"))},binData:function(t,e){var a,r,i,n,s,l;if(t.length<=e)return this.binSize=1,t=_.map(t,function(t,e){return{x:""+t.x,y:t.y,width:1,refCount:t.refCount}});a=void 0,i=Math.floor(t.length/e),this.binSize=i,(r=t.length%e)&&(e+=Math.floor(r/i),(r%=i)&&(a=r)),n=[],s=[],l=[];for(var h=0;h<e;h++)n.push(i);return a&&n.push(a),_.each(n,function(e,a){for(var r=0,i=0,n=[];e>=1;){var h=t[0];n.push(h.x),r+=h.y,i+=h.refCount,t.shift(),e-=1}s.push(n),l.push({totalCount:r,refCount:i})}),s=_.map(s,function(t,e){return t.length>1?{x:t[0]+"-"+t[t.length-1],width:t.length}:{x:t[0]+"",width:1}}),t=_.map(s,function(t,e){return{x:t.x,y:l[e].totalCount,refCount:l[e].refCount,width:t.width}})},graphChange:function(t,e){var a,r,i,n,s,l,h,d=this,o=(a=_.clone(this.model.get("graphData")))[0].x,c=a[a.length-1].x;t!==o||e!==c?this.trigger("facet:active"):this.trigger("facet:inactive"),a=_.filter(a,function(a,r){return a.x>=t&&a.x<=e}),a=this.binData(a,this.bins),!0===this.sizeSort&&(a=_.sortBy(a,function(t){return t.y})),i=_.pluck(a,"x"),maxVal=d3.max(_.pluck(a,"y")),r=d3.scale.ordinal().domain(i).rangeRoundBands([0,this.width],.1),n=d3.scale.linear().domain([0,maxVal]).range([this.height,0]),s=d3.svg.axis().scale(r).orient("bottom");var u=d3.format("s");l=d3.svg.axis().scale(n).orient("left").tickFormat(function(t){return t>=1&&t%1==0?u(t):""}),(h=this.innerChart.selectAll(".bar").data(a)).exit().remove();var f=h.enter().append("g").classed("bar",!0);f.append("rect").classed("full-bar",!0),f.append("rect").classed("refereed",!0);var g=i.length;h.transition(500).attr("transform",function(t){return"translate("+r(t.x)+",0)"}).delay(function(t,e){return 500*e/g}).select("rect").attr("y",function(t){return n(t.y)}).attr("height",function(t){return d.height-n(t.y)}).attr("width",function(t){return r.rangeBand()*t.width/d.binSize}),h.select(".refereed").transition(500).delay(function(t,e){return 500*e/g}).attr("y",function(t){return n(t.refCount)}).attr("height",function(t){return d.height-n(t.refCount)}).attr("width",function(t){return r.rangeBand()*t.width/d.binSize}),d3.select(this.el).select(".x-axis").call(s).selectAll("text").call(this.formatXAxisText),d3.select(this.el).select(".y-axis").transition().call(l).selectAll("text").style("text-anchor","start")},buildSlider:function(){var t=this,e=_.clone(this.model.get("graphData")),a=e[0].x,r=e[e.length-1].x;this.$(".slider").slider({range:!0,min:a,max:r,values:[a,r],stop:function(e,a){var r=a.values[0],i=a.values[1];t.graphChange(r,i)},slide:function(e,a){var r=a.values[0],i=a.values[1];t.$(".show-slider-data-first").val(r),t.$(".show-slider-data-second").val(i)},create:function(t){var e=$("a",t.target);e.attr("href","javascript:void(0)"),e.first().attr("title","start slider handle"),e.last().attr("title","end slider handle")}}),this.$(".show-slider-data-first").val(a),this.$(".show-slider-data-second").val(r)},addSliderWindows:function(){this.$(".slider-data").html('Limit results to papers from <br/> <input type="text" class="show-slider-data-first" aria-label="limit papers start year"></input> to <input type="text" class="show-slider-data-second" aria-label="limit papers end year"></input> <button class="apply btn btn-sm btn-primary-faded">Apply</button>')},triggerGraphChange:function(t){var e=_.clone(this.model.get("graphData"));if(_.isArray(e)){var a=e[0].x,r=e[e.length-1].x,i=this.$(".show-slider-data-first"),n=this.$(".show-slider-data-second"),s=i.val(),l=n.val();s=s<a?a:s,l=l>r?r:l,s=s>r?l:s,l=(l=l<a?s:l)<(s=s>l?l:s)?s:l,t&&(i.val(s),n.val(l)),this.$(".slider").slider("values",[s,l]),this.graphChange(s,l)}},submitFacet:function(){this.trigger("facet-applied",this.$(".slider").slider("values").join("-"))}})});