define(["marionette","backbone","utils","js/components/api_request","js/components/api_query","js/components/api_feedback","js/widgets/base/base_widget","hbs!js/widgets/list_of_things/templates/item-template","hbs!js/widgets/list_of_things/templates/results-container-template","js/mixins/add_stable_index_to_collection","./model","./paginated_view"],function(e,t,i,s,n,a,o,r,g,h,l,d){var c=o.extend({initialize:function(e){var t=this;e=e||{},_.defaults(e,_.pick(this,["view","collection","pagination","model","description","childView"])),this.pagination={pagination:!0,perPage:25,numFound:void 0,currentQuery:void 0,start:0,pageData:void 0,focusedIndex:-1},e.collection=e.collection||new l,e.view||(e.view=new d({collection:e.collection,model:e.model,childView:e.childView})),e.view.model.set(this.pagination,{silent:!0}),e.view.model.set({sortOrder:e.sortOrder,removeSelf:e.removeSelf,queryOperator:e.queryOperator,description:e.description},{silent:!0}),_.extend(this,{model:e.view.model,view:e.view}),this.hiddenCollection=new l,this.listenTo(this.hiddenCollection,"all",this.onAllInternalEvents),this.listenTo(this.view,"all",this.onAllInternalEvents),this.on("all",this.onAllInternalEvents),this.model.on("change:page",function(){t.model.set("focusedIndex",-1,{silent:!0})}),this.changePage=_.debounce(this.changePage.bind(this),500),o.prototype.initialize.call(this,e)},activate:function(e){var t=this;this.setBeeHive(e),_.bindAll(this,["updatePaginationPreferences"]);var i=this.getPubSub();if(this.getBeeHive().getObject("User")&&this.getBeeHive().getObject("User").getLocalStorage){var s=this.getBeeHive().getObject("User").getLocalStorage().perPage;s&&(this.pagination.perPage=s,this.model.set(this.pagination))}i.subscribe(i.INVITING_REQUEST,function(){t.updateState(t.STATES.LOADING)}),this.activateWidget(),this.attachGeneralHandler(this.onApiFeedback),i.subscribe(i.USER_ANNOUNCEMENT,this.updatePaginationPreferences),i.subscribe(i.CUSTOM_EVENT,function(e){"hotkey/next"===e?t.changePage(1):"hotkey/prev"===e?t.changePage(-1):"hotkey/item-next"===e?t.changeItemFocus(1):"hotkey/item-prev"===e?t.changeItemFocus(-1):"hotkey/item-select"===e&&t.selectItem()})},selectItem:function(){var e=this.model.get("focusedIndex");if(e>=0){var t=this.view.children.findByIndex(e);t&&t.toggleSelect&&t.toggleSelect()}},changeItemFocus:function(e){var t=this.view.children.length,i=this.model.get("focusedIndex");i<=0&&-1===e?i=t-1:i===t-1&&1===e?i=0:i+=e,this.model.set("focusedIndex",i,{silent:!0});var s=this.view.children.findByIndex(i);s&&s.el&&$(">",s.el).focus()},changePage:function(e){this.updatePagination({page:(this.model.get("page")||0)+e})},onApiFeedback:function(e){e.error&&(this.view.model.set("error",e.error),this.updateState(this.STATES.ERRORED))},updatePaginationPreferences:function(e,t){"user_info_change"==e&&t.perPage&&t.perPage!==this.pagination.perPage&&this.updatePagination({perPage:t.perPage})},_getCurrentQueryString:function(e){var t="",i=e||this.getBeeHive().getObject("AppStorage").getCurrentQuery();if(!_.isUndefined(i)&&(t=i.getApiQuery().get("q"),_.isEmpty(t)||t[0].indexOf("simbid")>-1))try{t=[i.get("responseHeader.params.__original_query")]}catch(e){t=""}return t},processResponse:function(e){var t=this.extractDocs(e),i=e.has("response.numFound")?e.get("response.numFound"):this.hiddenCollection.length,s=e.has("response.start")?e.get("response.start"):this.model.get("start"),n=this.getPaginationInfo(e,t),a=this;if((t=this.processDocs(e,t,n))&&t.length){var o=_.map(t,function(e){return _.extend(e,{showHighlights:!_.isEmpty(e.highlights),showCheckbox:!!a.model.get("showCheckboxes")})});this.hiddenCollection.add(o,{merge:!0}),0===this.hiddenCollection.filter(function(e){return e.get("highlights")}).length&&this.view.model.set("showHighlights","closed"),n.showRange&&(this.model.set(n),this.hiddenCollection.showRange(n.showRange[0],n.showRange[1])),this.view.collection.reset(this.hiddenCollection.getVisibleModels()),this.view.model.set("query",!1)}else{var r=e.get("responseHeader.params");this.view.model.set({isTugboat:!!r.__tb,query:this._getCurrentQueryString(e),currentQuery:e.getApiQuery()})}this.trigger("page-manager-event","widget-ready",{numFound:i});var g=this.model.has("perPage")&&this.model.get("perPage")===this.collection.length,h=this.model.has("pageData")&&!1===this.model.get("pageData").nextPossible;0===this.view.collection.length||g||h&&i<=s+t.length?(this.model.set("loading",!1),this.updateState(this.STATES.IDLE)):this.model.set("loading",!0)},extractDocs:function(e){var t=e.get("response.docs");return t=_.map(t,function(e){return e.all_ids=e.identifier,e.bibcode&&(e.identifier=e.bibcode?e.bibcode:e.identifier),e})},getPaginationInfo:function(e,t){var i=e.getApiQuery(),s=e.get("response.numFound")||0,n=this.model.get("perPage")||(i.has("rows")?i.get("rows")[0]:10),a=this.model.get("start")||0,o=h.getPageVal(a,n),r=[o*n,(o+1)*n-1];return i.has("__fetch_missing")?{start:a,showRange:r}:{numFound:s,perPage:n,start:a,page:o,showRange:r,pageData:this._getPaginationData(o,n,s),currentQuery:i}},_getPaginationData:function(e,t,i){return{perPage:t,totalPages:Math.ceil(i/t),currentPage:e+1,previousPossible:e>0,nextPossible:(e+1)*t<i}},processDocs:function(e,t,i){if(!e.has("response"))return[];var s=e.get("response").start||i.start||0;return t=h.addPaginationToDocs(t,s)},defaultQueryArguments:{fl:"id",start:0},updateLocalStorage:function(e){e.hasOwnProperty("perPage")&&_.contains([25,50,100,200,500],e.perPage)&&(this.getBeeHive().getObject("User").setLocalStorage({perPage:e.perPage}),console.log("set user's page preferences in localStorage: "+e.perPage))},updatePagination:function(e){var s=_.defaults({},e,{silentIndexUpdate:!1,updateHash:!0}),a=this.model.get("pageData"),o=this.model.get("start"),r={},g=(this.model.get("currentQuery")||new n).get("p_");if(_.isNumber(s.numFound)&&(r.numFound=s.numFound),_.isNumber(s.perPage)&&(r.perPage=s.perPage,this.pagination.perPage=s.perPage),_.isArray(g)&&_.isUndefined(s.page))try{s.page=parseInt(g[0])}catch(e){}if(_.isNumber(s.page)){var l=a&&a.totalPages-1||1;s.page>l?r.page=l:s.page<0?r.page=0:r.page=s.page}else if(_.isEmpty(this.collection.models)&&_.isNumber(o)&&_.isNumber(s.perPage))r.page=h.getPageVal(o,s.perPage);else if(_.isNumber(o)&&_.isNumber(s.perPage)){var d=this.collection.models[0].get("resultsIndex");r.page=h.getPageVal(d,s.perPage)}var c=_.isNumber(r.page)?r.page:this.model.get("page"),u=_.isNumber(r.perPage)?r.perPage:this.model.get("perPage"),p=_.isNumber(r.numFound)?r.numFound:this.model.get("numFound"),m=t.history&&t.history.getFragment&&t.history.getFragment();""+c!==(_.isArray(g)&&g[0])&&s.updateHash&&/search/.test(m)&&i.qs("p_",m)!==""+c&&t.history&&t.history.navigate&&t.history.navigate(i.updateHash("p_",c,m)),r.start=this.getPageStart(c,u,p),r.pageData=this._getPaginationData(c,u,p),r.showRange=[c*u,c*u+u-1],this.model.set(r),this.view.render(),this.hiddenCollection.showRange(r.showRange[0],r.showRange[1],{silent:!!s.silentIndexUpdate}),this.collection.reset(this.hiddenCollection.getVisibleModels()),document.body.scrollTop=document.documentElement.scrollTop=0,$("#app-container").scrollTop(0)},onAllInternalEvents:function(e,t,i){try{var s=this.getPubSub()}catch(e){}if("pagination:changePerPage"===e)this.updateLocalStorage({perPage:t}),this.updatePagination({page:0,perPage:t}),this.view.model.set("showHighlights","closed");else{if("pagination:select"===e)return this.view.model.set("showHighlights","closed"),this.updatePagination({page:t});if("show:missing"===e)_.each(t,function(e){var t=this.model.get("numFound"),i=e.start,s=this.model.get("perPage"),n=this.model.get("start");if(!(!t||i>=t||i!==n&&n>0)){var a=this.model.get("currentQuery").clone();a.unset("hl"),a.unset("hl.fl"),a.unset("hl.maxAnalyzedChars"),a.unset("hl.requireFieldMatch"),a.unset("hl.usePhraseHighlighter"),a.set("__fetch_missing","true"),a.set("start",i),a.set("rows",s-i<=0?s:s-i);var o=this.composeRequest(a);this.executeRequest(o)}},this);else if("childview:toggleSelect"==e)s.publish(s.PAPER_SELECTION,i.data.identifier);else if("toggle-highlights"===e){var n=this.model.get("perPage");this.hiddenCollection.length<n&&(n=this.hiddenCollection.length);var a=this.model.get("start"),o=n>300?5:n<=50?1:2,r=_.bind(function(e,t){var i=this.model.get("currentQuery").clone();i.set({hl:"true","hl.fl":"title,abstract,body,ack","hl.maxAnalyzedChars":"150000","hl.requireFieldMatch":"true","hl.usePhraseHighlighter":"true",start:a+e,rows:t});var s=this.composeRequest(i);this.executeRequest(s)},this);_.debounce(_.bind(function(){for(var e=this.hiddenCollection.filter(function(e){return e.get("highlights")}).length,t=Math.ceil((n-e)/o),i=e,s=1;i<n;i+=t,s++)i===e?r(i,t):setTimeout(r,500*s,i,t)},this),3e3)()}}},executeRequest:function(e){this.getPubSub().publish(this.getPubSub().EXECUTE_REQUEST,e)},reset:function(){this.collection.reset(),this.hiddenCollection.reset(),this.model.set(_.defaults({currentQuery:this.getCurrentQuery(),query:!1},this.pagination,this.model.defaults()))}});return _.extend(c.prototype,h),c});