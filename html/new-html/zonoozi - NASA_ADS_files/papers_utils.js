define(["underscore","jquery-ui","jquery"],function(t,r,e){return{formatDate:function(r,i){if(i&&!t.isObject(i))throw new Error("format must be an object of string formats");var a,n,o,s=["day","month"];if(o=(i=t.defaults(i||{},{format:"yy/mm/dd",missing:{day:"yy/mm",month:"yy"},separator:"-",junk:"-00"})).format,n=new Date(r),t.isNaN(n.getYear())){for(var d=0,f=r,u=i.junk;f.indexOf(u)>-1;){f=f.substring(0,f.lastIndexOf(u));try{if(n=new Date(f),!t.isNaN(n.getYear())&&!(o=i.missing[s[d]]))throw new Error("format is missing: "+s[d])}catch(t){}d+=1}if(t.isNaN(n.getYear()))throw new Error("Error parsing input: "+r)}else{var m=i.separator;if(r.indexOf(m)>-1){var h=r.split(m);if(2==h.length?o=i.missing[s[0]]:1==h.length&&(o=i.missing[s[1]]),!o)throw new Error("format is missing: missing."+s[d])}}return a=new Date(n.getTime()+6e4*n.getTimezoneOffset()),e.datepicker.formatDate(o,a)},shortenAbstract:function(t,r){if(r=r||300,!(t.length<=r)){var e=t.slice(0,r).lastIndexOf(" ");return t.slice(0,e+1)+"..."}},prepareDocForViewing:function(r){var e;if(r.author&&r.author.length>3?(r.extraAuthors=r.author.length-3,e=r.author.slice(0,3)):r.author&&(e=r.author),r.author){var i=function(t,r,e){var i=e.length-1;return r===i||0===i?t:t+";"};r.authorFormatted=t.map(e,i),r.allAuthorFormatted=t.map(r.author,i)}return r.formattedDate=r.formattedDate||(r.pubdate?this.formatDate(r.pubdate):void 0),r.shortAbstract=r.abstract?this.shortenAbstract(r.abstract):void 0,r.details=r.details||{shortAbstract:r.shortAbstract,pub:r.pub,abstract:r.abstract},r.num_citations=r["[citations]"]?r["[citations]"].num_citations:void 0,r.identifier=r.bibcode?r.bibcode:r.identifier,r.encodedIdentifier=t.isUndefined(r.identifier)?r.identifier:encodeURIComponent(r.identifier),(r.pubdate||r.shortAbstract)&&(r.popover=!0),this.model&&(r.orderNum=this.model.get("resultsIndex")+1),r}}});