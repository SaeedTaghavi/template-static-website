define(["./base_graph","hbs!js/widgets/facet/graph-facet/templates/h-index-graph-legend","hbs!js/widgets/facet/graph-facet/templates/h-index-slider-window","marionette"],function(t,e,a,i){return t.extend({legendTemplate:e,xAxisClassName:"h-index-x-axis-title",addToOnRender:function(){this.hIndex&&this.$(".h-index-container").text(this.hIndex.x)},events:{"click .apply":"submitFacet","blur input[type=text]":"triggerGraphChange","change input[name*=scale]":"toggleScale"},buildGraph:function(){var t,e,a,r,n,s,l,h;t=_.clone(this.model.get("graphData")),this.hIndex=t[_.indexOf(t,_.findWhere(t,function(t){if(t.x>t.y)return!0}))-1],e=_.pluck(t,"x");var d=_.pluck(t,"y");maxVal=d3.max(d),minVal=d3.min(d);var c=[e[0]-1,e[e.length-1]+1];(a=d3.scale.linear().domain(c).range([0,this.width]),r=d3.scale.linear().domain([minVal-1,maxVal+1]).range([this.height,0]),n=d3.svg.axis().scale(a).orient("bottom"),standardFormatter=d3.format("s"),s=d3.svg.axis().scale(r).orient("left").tickFormat(function(t){return t>=1&&t%1==0?standardFormatter(t):""}),console.log("lsdkjf",this),l=d3.select(this.el).select(".chart").attr("width",this.fullWidth).attr("height",this.fullHeight).attr("aria-label",this.yAxisTitle+" graph"),this.innerChart=l.append("g").classed("inner-chart",!0).attr("transform","translate("+this.margin.left+","+this.margin.top+")"),this.innerChart.append("g").classed({axis:!0,"x-axis":!0}).attr("transform","translate(0,"+this.height+")").call(n).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy",".15em").attr("transform",function(t){return"rotate(-65)"}),this.innerChart.append("g").classed({axis:!0,"y-axis":!0}).call(s),t.length>=40)?(h=d3.svg.line().x(function(t){return a(t.x)}).y(function(t){return r(t.y)}),this.innerChart.append("path").datum(t).classed("line",!0).attr("d",h)):(this.$(".ref-nonref").removeClass("hidden"),this.innerChart.selectAll("circle").data(t).enter().append("circle").attr("class","dot").attr("r",2).classed("refereed",function(t){if(t.refereed)return!0}).attr("cx",function(t){return a(t.x)}).attr("cy",function(t){return r(t.y)}));this.hIndex&&(this.innerChart.append("line").classed({"h-index":!0,"h-index-1":!0}).attr("x1",a(this.hIndex.x)).attr("y1",r(minVal-1)).attr("x2",a(this.hIndex.x)).attr("y2",r(this.hIndex.y)),this.innerChart.append("line").classed({"h-index":!0,"h-index-2":!0}).attr("x1",a(e[0]-1)).attr("y1",r(this.hIndex.y)).attr("x2",a(this.hIndex.x)).attr("y2",r(this.hIndex.y))),this.innerChart.append("text").attr("class","s-label").attr("x",this.width/2-20).attr("y",180).text(i.getOption(this,"xAxisTitle")),this.innerChart.append("text").attr("class","s-label").attr("y",-40).attr("x",-this.height/2).attr("transform","rotate(-90)").text(i.getOption(this,"yAxisTitle"))},toggleScale:function(t){var e=$(t.target).attr("value");this.currentScale=e,this.graphChange()},graphChange:function(t){var e,a,i,r,n;t!==(e=_.clone(this.model.get("graphData")))[e.length-1].x?this.trigger("facet:active"):this.trigger("facet:inactive"),t?this.limitVal=t:this.limitVal||(this.limitVal=d3.max(_.pluck(e,"x"))),e=_.filter(e,function(t,e){return"log"===this.currentScale?t.x<=this.limitVal&&t.y>0:t.x<=this.limitVal},this);var s=_.pluck(e,"x"),l=_.pluck(e,"y");maxVal=d3.max(l),minVal=d3.min(l);var h=[s[0]-1,s[s.length-1]+1];if(a=d3.scale.linear().domain(h).range([0,this.width]),r=d3.svg.axis().scale(a).orient("bottom").tickFormat(d3.format("d")),"linear"===this.currentScale?i=d3.scale.linear().domain([minVal-1,maxVal+1]).range([this.height,0]):"log"===this.currentScale&&(i=d3.scale.log().domain([_.max([1,minVal-1]),maxVal+1]).range([this.height,0]).clamp(!0)),d3.select(this.el).select(".x-axis").call(r).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy",".15em").attr("transform",function(t){return"rotate(-65)"}),standardFormatter=d3.format("s"),n=d3.svg.axis().scale(i).orient("left"),"log"===this.currentScale){var d=d3.format("s");n.tickFormat(function(t){var e=Math.log(t)/Math.log(10)+1e-6;return Math.abs(e-Math.floor(e))<.7?d(t):""})}else n=d3.svg.axis().scale(i).orient("left").tickFormat(function(t){return t>=1&&t%1==0?standardFormatter(t):""});if(d3.select(this.el).select(".y-axis").transition().call(n),this.hIndex&&(_.contains(e,this.hIndex)?this.innerChart.selectAll(".h-index").classed("hidden",!1):this.innerChart.selectAll(".h-index").classed("hidden",!0),this.innerChart.select(".h-index-1").transition().attr("x1",a(this.hIndex.x)).attr("x2",a(this.hIndex.x)).attr("y2",i(this.hIndex.y)),this.innerChart.select(".h-index-2").transition().attr("y1",i(this.hIndex.y)).attr("x2",a(this.hIndex.x)).attr("y2",i(this.hIndex.y))),e.length>=40)$(".ref-nonref").addClass("hidden"),line=d3.svg.line().x(function(t){return a(t.x)}).y(function(t){return i(t.y)}),this.innerChart.selectAll(".dot").classed("hidden",!0),this.innerChart.selectAll(".line").datum(e).attr("d",line).classed("hidden",!1);else{this.$(".ref-nonref").removeClass("hidden"),this.innerChart.selectAll(".line").classed("hidden",!0),this.innerChart.selectAll(".dot").classed("hidden",!1);var c=this.innerChart.selectAll("circle").data(e);c.exit().remove(),c.enter().append("circle").attr("class","dot").attr("r",2),c.classed("refereed",function(t){if(t.refereed)return!0}).attr("cx",function(t){return a(t.x)}).attr("cy",function(t){return i(t.y)})}},buildSlider:function(){var t=this,e=_.clone(this.model.get("graphData")),a=e[e.length-1].x,i=e[0].x;this.$(".slider").slider({max:a,min:i,value:a,stop:function(e,a){t.graphChange(a.value)},slide:function(e,a){t.$(".show-slider-data-first").val(a.value)},create:function(t){var e=$("a",t.target);e.attr("href","javascript:void(0)"),e.attr("title","slider handle")}}),this.$(".show-slider-data-first").val(a)},addSliderWindows:function(){this.$(".slider-data").html(a({pastTenseTitle:this.pastTenseTitle}))},triggerGraphChange:function(t){var e=_.clone(this.model.get("graphData"));if(_.isArray(e)){var a=e[0].x,i=e[e.length-1].x,r=this.$(".show-slider-data-first"),n=r.val();n=(n=n<a?a:n)>i?i:n,t&&r.val(n),this.$(".slider").slider("value",n),this.graphChange(n)}},submitFacet:function(){var t=this.model.get("graphData")[this.$(".slider").slider("value")-1].y;this.trigger("facet-applied","["+t+" TO 9999999]")}})});