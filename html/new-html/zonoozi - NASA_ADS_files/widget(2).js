define(["underscore","marionette","d3","js/widgets/base/base_widget","./extractor_functions","js/components/api_response","js/components/json_response","js/components/api_request","js/components/api_query","js/mixins/dependon","hbs!js/widgets/metrics/templates/metrics_container","hbs!js/widgets/metrics/templates/graph_template","hbs!js/widgets/metrics/templates/paper_table","hbs!js/widgets/metrics/templates/citations_table","hbs!js/widgets/metrics/templates/indices_table","hbs!js/widgets/metrics/templates/reads_table","bootstrap","js/components/api_feedback","js/components/api_targets","./d3-tip"],function(e,t,a,i,r,n,s,o,d,l,c,h,u,f,m,p,b,w,v,x){function y(e){if(!e)return e;var t=e.toString();return t.indexOf(".")>-1&&t.split(".")[1]?e.toFixed(1):e}var V=Backbone.Model.extend({defaults:function(){return{title:[],rows:[]}}}),E=t.ItemView.extend({className:"table table-hover s-metrics-table table-condensed",tagName:"table",onRender:function(){this.$('[data-toggle="popover"]').popover({html:!0,trigger:"hover"})}}),G=Backbone.Model.extend({defaults:function(){return{graphData:void 0,normalizedGraphData:void 0,normalized:!1,graphType:"histogram",barArrangement:"stacked",yAxisLabel:"Papers"}}}),_=t.ItemView.extend({className:"graph-view s-graph-view",initialize:function(){this.initial=!0},modelEvents:{"change:normalized":"render"},ui:{svg:"svg"},events:{"click .graph-tab":"updateTabValue"},updateTabValue:function(e){"normalized"===$(e.currentTarget).data("tab")?this.model.set("normalized",!0):this.model.set("normalized",!1)},colors:["#5683e0","#7ab889","#ffb639","#ed5e5b","#ce5cff","#1c459b"],drawHistogram:function(){var t=this.model.get("normalized")?this.model.get("normalizedGraphData"):this.model.get("graphData"),i=t.length,r=a.layout.stack()(t.map(function(e){return e.values})),n=a.max(r,function(e){return a.max(e,function(e){return e.y})}),s=a.max(r,function(e){return a.max(e,function(e){return e.y0+e.y})}),o=a.select(this.$("svg")[0]),d=this,l=20,c=50,h=480-c-10,u=250-l-20,f=this.model.get("graphData")[0].values.map(function(e){return e.x}),m=a.scale.ordinal().domain(f).rangeRoundBands([0,h],.08),p=a.scale.linear().domain([0,s]).range([u,0]);this.$("svg").empty();var b=o.append("g").attr("transform","translate("+c+","+l+")").classed("graph-container-g",!0);o.selectAll("[data-legend]").data(e.map(t,"key")).enter().append("g").attr("data-legend",e.identity).attr("data-legend-color",function(e,t){return d.colors[t]}),setTimeout(function(){o.append("g").attr("class","legend").attr("transform","translate(70, 20)").attr("data-style-padding",7).style("font-size","12px").call(a.legend)},500),this.tip||(this.tip=a.tip().attr("class","d3-tip").offset([-10,0]).html(function(t){var a=d.model.get("normalized")?"normalizedGraphData":"graphData";return d.model.get(a).map(function(a){return"<b>"+a.key+"</b>:&nbsp;"+e.findWhere(a.values,{x:t.x}).y.toFixed(2)}).join("<br/>")})),b.call(this.tip),b.append("g").attr("class","x axis").attr("transform","translate(0,"+u+")"),b.append("g").attr("class","y axis").attr("transform","translate(0,0)"),b.append("text").attr("text-anchor","middle").attr("transform","translate(-40,"+u/2+")rotate(-90)").classed("graph-label",!0).text(this.model.get("yAxisLabel")),this.$("input[name=bar-arrangement]").on("change",function(e){"grouped"===this.value?(p.domain([0,n]),w.transition().duration(500).delay(function(e,t){return 10*t}).attr("x",function(e,t,a){return m(e.x)+m.rangeBand()/i*a}).attr("width",m.rangeBand()/i).transition().attr("y",function(e){return p(e.y)}).attr("height",function(e){return u-p(e.y)})):(p.domain([0,s]),w.transition().duration(500).delay(function(e,t){return 10*t}).attr("y",function(e){return p(e.y0+e.y)}).attr("height",function(e){return p(e.y0)-p(e.y0+e.y)}).transition().attr("x",function(e){return m(e.x)}).attr("width",m.rangeBand()))});var g,w=b.selectAll(".layer").data(r).enter().append("g").attr("class","layer").style("fill",function(e,t){return d.colors[t]}).selectAll("rect").data(function(e){return e}).enter().append("rect").attr("width",m.rangeBand()).attr("x",function(e){return m(e.x)}).on("mouseover",this.tip.show).on("mouseout",this.tip.hide);if(f.length>20){var v=Math.floor(f.length/5);g=f.filter(function(e){return e%v==0})}else g=f.length>8?f.filter(function(e){return e%2==0}):f;var x=a.svg.axis().scale(m).tickSize(0).tickValues(g).tickPadding(6).orient("bottom"),y=s>1?5:0,V=a.svg.axis().scale(p).tickSize(0).ticks(y).tickFormat(function(e){return e>1?a.format("s")(e):a.format(".1n")(e)}).orient("left");b.select(".x.axis").call(x),b.select(".y.axis").transition().call(V),b.selectAll("rect").transition().delay(function(e,t){return 10*t}).attr("y",function(e){return p(e.y0+e.y)}).attr("height",function(e){return p(e.y0)-p(e.y0+e.y)})},drawLineGraph:function(){var t=this;this.$(".stacked-form").remove();var i=a.tip().attr("class","d3-tip").offset([-10,0]).html(function(e){return e.key}),r=this.model.get("graphData");if(r){r.forEach(function(e){e.values.forEach(function(e){e.x=parseInt(e.x)})});var n=r[0].values.map(function(e){return e.x}),s=a.select(this.$("svg")[0]),o=20,d=50,l=480-d-80,c=250-o-30;if(g=s.append("g").attr("transform","translate("+d+","+o+")").attr("pointer-events","all"),1!==n.length){var h=a.scale.linear().domain(a.extent(n)).range([0,l]),u=a.scale.linear().range([c,0]);u.domain([0,a.max(e.flatten(r.map(function(e){return e.values.map(function(e){return e.y})})))]);var f,m,p,b,w,v,x,y,V,E,G=a.svg.axis().scale(h).tickSize(0).ticks(5).tickFormat(a.format()).tickPadding(6).orient("bottom"),_=a.svg.axis().scale(u).tickSize(0).ticks(5).tickFormat(function(e){return e>1?a.format("s")(e):a.format(".1n")(e)}).orient("left"),T=a.svg.line().x(function(e){return h(e.x)}).y(function(e){return u(e.y)});g.call(i),g.append("g").attr("class","x axis").attr("transform","translate(0,"+c+")").call(G),g.append("g").attr("class","y axis").call(_),g.selectAll(".index").data(r).enter().append("g").attr("class","index").append("path").attr("class","line").attr("d",function(e){return T(e.values)}).style("stroke",function(e,a){return t.colors[a]}),f=e.reduce(r,function(e,t){return e[t.key]=t.values,e},{}),m=s.append("g").attr("pointer-events","all"),p=m.append("line").attr({"pointer-events":"none",x1:d,x2:d,y1:o,y2:c+o,stroke:"black","stroke-width":"1px"}),b=e.map(f,function(e,t){return{key:t,el:m.append("circle").attr({r:3,"stroke-width":"2px",fill:"none","pointer-events":"none"}),data:e}}),w=g.append("foreignObject").attr({class:"info-box",width:"200px",height:"100px",x:"100"}).style({opacity:.75,"font-size":"0.60em"}),v=e.memoize(function(e){if(e){var t="<table>";for(var a in t+="<tr><td><strong>Year:</strong></td><td>&nbsp;"+e.year+"</td></tr>",e.groups){var i=e.groups[a];t+="<tr>",t+='<td style="color:'+i.color+'"><strong>'+i.key+":</strong></td>",t+="<td>&nbsp;"+i.val.toFixed(5)+"</td>",t+="</tr>"}return t+="</table>"}},function(e){return e.year}),x=e.memoize(function(t){var i=a.bisector(function(e){return e.x}).left,r=[];return e.forEach(b,function(e){var a=e.data,n=i(a,t),s=a[n-1]||0,l=a[n]||a[a.length-1],c=t-s.x<l.x===t?s:l,f=h(c.x)+d,m=u(c.y)+o;r.push({dot:e,data:c,pos:{x:f,y:m}})},0),r}),y=e.memoize(function(t){return e.reduce(t,function(e,t){return e+t.pos.x},0)/t.length},function(e){return e[0].data.x}),V=function(e,a,i){var r=a.dot.el,n=a.data,s=a.pos;r.attr({visibility:null,transform:"translate("+s.x+","+s.y+")",stroke:t.colors[i]}),e.year=n.x,e.groups.push({key:a.dot.key,val:n.y,color:t.colors[i]})},E=e.debounce(function(){w.html(""),p.attr("visibility","hidden"),e.forEach(b,function(e){e.el.attr("visibility","hidden")})},300,{leading:!0}),g.append("rect").attr({x:-10,width:l+20,height:c,visibility:"hidden"}).on("mouseout",E).on("mousemove",function(){var t=a.mouse(this),i=x(h.invert(t[0]).toFixed(0)),r=y(i),n={year:0,groups:[]};e.forEach(i,e.partial(V,n)),w.html(v(n)),p.attr({x1:r,x2:r,visibility:null})}),s.selectAll("[data-legend]").data(e.map(r,"key")).enter().append("g").attr("data-legend",e.identity).attr("data-legend-color",function(e,a){return t.colors[a]}),setTimeout(function(){s.append("g").attr("class","legend").attr("transform","translate(70, 36)").attr("data-style-padding",7).style("font-size","12px").call(a.legend)},500)}else g.append("text").attr("x",10).attr("y",100).text("time period is less than a year, refer to table to the left for values")}},drawGraph:function(){var e=this.model.get("graphType");"histogram"===e?this.drawHistogram():"line"===e&&this.drawLineGraph()},template:h,onRender:function(){var e=this;this.drawGraph(),setTimeout(function(){$("svg",e.el).attr("aria-label",e.model.get("yAxisLabel")+" graph")},0)}}),T=Backbone.Model.extend({defaults:function(){return{widgetName:"Metrics"}}}),D=t.LayoutView.extend({template:c,events:{"click .close-widget":"signalCloseWidget","click .show-all":"signalShowAll"},signalCloseWidget:function(){$(".d3-tip").remove(),this.trigger("close-widget")},signalShowAll:function(){this.$(".show-all").html('<i class="icon-loading"/>&nbsp;&nbsp;'+this.$(".show-all").html()),this.trigger("show-all")},modelEvents:{change:"render"},regions:{papersGraph:"#papers .metrics-graph",papersTable:"#papers .metrics-table",citationsGraph:"#citations .metrics-graph",citationsTable:"#citations .metrics-table",indicesGraph:"#indices .metrics-graph",indicesTable:"#indices .metrics-table",readsGraph:"#reads .metrics-graph",readsTable:"#reads .metrics-table"}}),S=i.extend({viewEvents:{"close-widget":"closeWidget","show-all":"showAll"},initialize:function(e){e=e||{},this.containerModel=new T,this.view=new D({model:this.containerModel}),this.childViews={},t.bindEntityEvents(this,this.view,t.getOption(this,"viewEvents")),this.dataExtractor=r,this.GraphModel=G,this.GraphView=_},defaultQueryArguments:{fl:["bibcode"]},components:{TableModel:V,TableView:E,GraphView:_,GraphModel:G,ContainerView:D},activate:function(t){this.setBeeHive(t),e.bindAll(this,"setCurrentQuery","processMetrics","checkIfSimpleRequired");var a=t.getService("PubSub");a.subscribe(a.INVITING_REQUEST,this.setCurrentQuery),this.activateWidget(),this.attachGeneralHandler(this.onApiFeedback)},onApiFeedback:function(){this.closeWidget();var e=this.getPubSub();e.publish(e.ALERT,new w({code:0,msg:"Sorry Metrics are unavailable at this time, try again later",type:"danger"}))},closeWidget:function(){this.reset(),this.componentParams&&this.componentParams.allowRedirect&&this.getPubSub().publish(this.getPubSub().NAVIGATE,"results-page")},showAll:function(){this.getIndicators()},reset:function(){this.childViews={},e.each(this.view.regions,function(e,t){this.view[t].currentView&&this.view[t].currentView.destroy()},this),this.containerModel.clear({silent:!0})},createTableViews:function(e,t){var a=1===t?this.createTableDataForOnePaper(e):this.createTableData(e);this.childViews.papersTableView=new E({template:u,model:new V(a.paperModelData)}),this.childViews.readsTableView=new E({template:p,model:new V(a.readsModelData)}),this.childViews.citationsTableView=new E({model:new V(a.citationsModelData),template:f}),this.childViews.indicesTableView=new E({model:new V(a.indicesModelData),template:m})},createTableData:function(t){var a={},i={refereed:t["basic stats refereed"],total:t["basic stats"]},r={refereed:t["citation stats refereed"],total:t["citation stats"]},n={refereed:t["indicators refereed"],total:t.indicators};return a.paperModelData={totalNumberOfPapers:[i.total["number of papers"],i.refereed["number of papers"]],totalNormalizedPaperCount:[i.total["normalized paper count"],i.refereed["normalized paper count"]]},a.readsModelData={totalNumberOfReads:[i.total["total number of reads"],i.refereed["total number of reads"]],averageNumberOfReads:[i.total["average number of reads"],i.refereed["average number of reads"]],medianNumberOfReads:[i.total["median number of reads"],i.refereed["median number of reads"]],totalNumberOfDownloads:[i.total["total number of downloads"],i.refereed["total number of downloads"]],averageNumberOfDownloads:[i.total["average number of downloads"],i.refereed["average number of downloads"]],medianNumberOfDownloads:[i.total["median number of downloads"],i.total["median number of downloads"]]},a.citationsModelData={numberOfCitingPapers:[r.total["number of citing papers"],r.refereed["number of citing papers"]],totalCitations:[r.total["total number of citations"],r.refereed["total number of citations"]],numberOfSelfCitations:[r.total["number of self-citations"],r.refereed["number of self-citations"]],averageCitations:[r.total["average number of citations"],r.refereed["average number of citations"]],medianCitations:[r.total["median number of citations"],r.refereed["median number of citations"]],normalizedCitations:[r.total["normalized number of citations"],r.refereed["normalized number of citations"]],refereedCitations:[r.total["total number of refereed citations"],r.refereed["total number of refereed citations"]],averageRefereedCitations:[r.total["average number of refereed citations"],r.refereed["average number of refereed citations"]],medianRefereedCitations:[r.total["median number of refereed citations"],r.refereed["median number of refereed citations"]],normalizedRefereedCitations:[r.total["normalized number of refereed citations"],r.refereed["normalized number of refereed citations"]]},a.indicesModelData={hIndex:[n.total.h,n.refereed.h],mIndex:[n.total.m,n.refereed.m],gIndex:[n.total.g,n.refereed.g],i10Index:[n.total.i10,n.refereed.i10],i100Index:[n.total.i100,n.refereed.i100],toriIndex:[n.total.tori,n.refereed.tori],riqIndex:[n.total.riq,n.refereed.riq],read10Index:[n.total.read10,n.refereed.read10]},e.each(a,function(t,a){e.each(t,function(e,a){t[a]=[y(e[0]),y(e[1])]})}),a},createGraphViews:function(e){var t=e.histograms,a=new G;this.childViews.papersGraphView=new _({model:a}),this.childViews.papersGraphView.model.set("graphData",this.dataExtractor.plot_paperhist({norm:!1,paperhist_data:t.publications})),this.childViews.papersGraphView.model.set("normalizedGraphData",this.dataExtractor.plot_paperhist({norm:!0,paperhist_data:t.publications}));var i=new G({yAxisLabel:"Citations"});this.childViews.citationsGraphView=new _({model:i}),this.childViews.citationsGraphView.model.set("graphData",this.dataExtractor.plot_citshist({norm:!1,citshist_data:t.citations})),this.childViews.citationsGraphView.model.set("normalizedGraphData",this.dataExtractor.plot_citshist({norm:!0,citshist_data:t.citations}));var r=new G;this.childViews.readsGraphView=new _({model:r}),this.childViews.readsGraphView.model.set("graphData",this.dataExtractor.plot_readshist({norm:!1,readshist_data:t.reads})),this.childViews.readsGraphView.model.set("normalizedGraphData",this.dataExtractor.plot_readshist({norm:!0,readshist_data:t.reads}));var n=new G({graphType:"line"});this.childViews.indicesGraphView=new _({model:n}),e["time series"]?this.childViews.indicesGraphView.model.set("graphData",this.dataExtractor.plot_series({series_data:e["time series"]})):this.childViews.indicesGraphView.model.set({showingSimple:!0})},insertViews:function(){this.view.render(),["papers","citations","indices","reads"].forEach(function(e){this.view[e+"Table"].show(this.childViews[e+"TableView"]),this.view[e+"Graph"].show(this.childViews[e+"GraphView"])},this)},insertViewsForOnePaper:function(e){this.view.render({title:this.containerModel.get("title")}),this.view.$("#indices").hide(),this.view.$("#papers").hide(),this.view.$(".metrics-metadata").hide(),this.hasReads(e)?(this.view.readsTable.show(this.childViews.readsTableView),this.view.readsGraph.show(this.childViews.readsGraphView)):this.view.$(this.view.readsTable.el).html("No reads found for this article."),this.hasCitations(e)?(this.view.citationsTable.show(this.childViews.citationsTableView),this.view.citationsGraph.show(this.childViews.citationsGraphView)):this.view.$(this.view.citationsTable.el).html("No citations found for this article."),this.view.$(".hidden-abstract-page").hide()},createGraphViewsForOnePaper:function(e){var t=e.histograms,a=new this.GraphModel;this.childViews.citationsGraphView=new this.GraphView({model:a}),this.childViews.citationsGraphView.model.set("graphData",this.dataExtractor.plot_citshist({norm:!1,citshist_data:t.citations})),this.childViews.citationsGraphView.model.set("normalizedGraphData",this.dataExtractor.plot_citshist({norm:!0,citshist_data:t.citations}));var i=new this.GraphModel;this.childViews.readsGraphView=new this.GraphView({model:i}),this.childViews.readsGraphView.model.set("graphData",this.dataExtractor.plot_readshist({norm:!1,readshist_data:t.reads})),this.childViews.readsGraphView.model.set("normalizedGraphData",this.dataExtractor.plot_readshist({norm:!0,readshist_data:t.reads}))},createTableDataForOnePaper:function(t){var a={},i={refereed:t["basic stats refereed"],total:t["basic stats"]},r={refereed:t["citation stats refereed"],total:t["citation stats"]};return a.readsModelData={totalNumberOfReads:[i.total["total number of reads"],i.refereed["total number of reads"]],averageNumberOfReads:[i.total["average number of reads"],i.refereed["average number of reads"]],medianNumberOfReads:[i.total["median number of reads"],i.refereed["median number of reads"]],totalNumberOfDownloads:[i.total["total number of downloads"],i.refereed["total number of downloads"]],averageNumberOfDownloads:[i.total["average number of downloads"],i.refereed["average number of downloads"]],medianNumberOfDownloads:[i.total["median number of downloads"],i.total["median number of downloads"]]},a.citationsModelData={numberOfCitingPapers:[r.total["number of citing papers"],r.refereed["number of citing papers"]],totalCitations:[r.total["total number of citations"],r.refereed["total number of citations"]],numberOfSelfCitations:[r.total["number of self-citations"],r.refereed["number of self-citations"]],averageCitations:[r.total["average number of citations"],r.refereed["average number of citations"]],medianCitations:[r.total["median number of citations"],r.refereed["median number of citations"]],normalizedCitations:[r.total["normalized number of citations"],r.refereed["normalized number of citations"]],refereedCitations:[r.total["total number of refereed citations"],r.refereed["total number of refereed citations"]],averageRefereedCitations:[r.total["average number of refereed citations"],r.refereed["average number of refereed citations"]],medianRefereedCitations:[r.total["median number of refereed citations"],r.refereed["median number of refereed citations"]],normalizedRefereedCitations:[r.total["normalized number of refereed citations"],r.refereed["normalized number of refereed citations"]]},e.each(a,function(t,a){e.each(t,function(e,a){t[a]=[y(e[0]),y(e[1])]})}),a},hasCitations:function(e){return e["citation stats"]["total number of citations"]>0},hasReads:function(e){return e["basic stats"]["total number of reads"]>0},renderWidgetForCurrentQuery:function(e){e=e||{},this.reset(),this.containerModel.set({url:window.location.href,loading:!0});var t=this.getCurrentQuery()||e.currentQuery;t=this.customizeQuery(t);var a=this,i=[],r=void 0,n=v._limits.Metrics.default;t.set("rows",1e3);var s=function(o){t.set({start:o}),this._executeSearch(t).done(function(t){i=i.concat(t.get("response.docs").map(function(e){return e.bibcode})),r=r||t.get("response").numFound,(o+=1e3)>=r||o>=n?(r>n&&void 0===e.simple&&(e.simple=!0),a.containerModel.set({numFound:r>n?n:r,bibcodes:i}),a.getMetrics(i,e)):s(o)})}.bind(this);s(0)},checkIfSimpleRequired:function(){if(!this._currentQuery)return(new $.Deferred).resolve(!1);var e=this._currentQuery.clone();return e.unlock(),e.set({stats:"true","stats.field":"citation_count",fl:"id"}),this._executeSearch(e).then(function(e){return e.get("stats.stats_fields.citation_count.sum")>5e4})},getIndicators:function(){var t=this.getPubSub(),a=new d({bibcodes:this.containerModel.get("bibcodes"),types:["indicators","timeseries"]}),i=new o({target:v.SERVICE_METRICS,query:a,options:{type:"POST",contentType:"application/json"}});function r(t){var a=t.toJSON();this.childViews.indicesGraphView.model.set({graphData:this.dataExtractor.plot_series({series_data:a["time series"]}),showingSimple:!1});var i={refereed:a["indicators refereed"],total:a.indicators},r={hIndex:[i.total.h,i.refereed.h],mIndex:[i.total.m,i.refereed.m],gIndex:[i.total.g,i.refereed.g],i10Index:[i.total.i10,i.refereed.i10],i100Index:[i.total.i100,i.refereed.i100],toriIndex:[i.total.tori,i.refereed.tori],riqIndex:[i.total.riq,i.refereed.riq],read10Index:[i.total.read10,i.refereed.read10]};e.each(r,function(e,t){r[t]=[y(e[0]),y(e[1])]}),this.childViews.indicesTableView.model.set(r),this.childViews.indicesTableView.render(),this.childViews.indicesGraphView.render()}r=r.bind(this),t.subscribeOnce(t.DELIVERING_RESPONSE,r),t.publish(t.EXECUTE_REQUEST,i)},getMetrics:function(e,t){t=t||{};var a=$.Deferred();function i(t){var i=this.getPubSub(),r=new d({bibcodes:e});t&&r.set({types:["simple"]});var n=new o({target:v.SERVICE_METRICS,query:r,options:{type:"POST",contentType:"application/json"}});function s(){try{this.processMetrics.apply(this,arguments),a.resolve()}catch(e){a.reject()}}s=s.bind(this),i.subscribeOnce(i.DELIVERING_RESPONSE,s),i.publish(i.EXECUTE_REQUEST,n)}return i=i.bind(this),void 0!==t.simple?i(t.simple):this.checkIfSimpleRequired().done(i),a.promise()},processMetrics:function(e){if(this.containerModel.set("loading",!1),(e=e.attributes?e.attributes:e).Error||500===e.status)throw this.closeWidget(),new Error("Metrics Service Error");1===e["basic stats"]["number of papers"]?(this.createTableViews(e,1),this.createGraphViewsForOnePaper(e),this.insertViewsForOnePaper(e)):(this.createTableViews(e),this.createGraphViews(e),this.insertViews(e))},_executeSearch:function(t){var a=this.getPubSub(),i=new o({target:v.SEARCH,query:t}),r=$.Deferred();return a.subscribeOnce(a.DELIVERING_RESPONSE,e.bind(function(e){r.resolve(e)}),this),a.publish(a.EXECUTE_REQUEST,i),r},renderWidgetForListOfBibcodes:function(e){this.reset(),this.containerModel.set({numFound:e.length,loading:!0}),this.getMetrics(e,{simple:!1})}});return e.extend(S.prototype,l.BeeHive),S});