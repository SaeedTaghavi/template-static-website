define(["marionette","js/widgets/base/base_widget","hbs!js/widgets/dropdown-menu/templates/dropdown","hbs!js/widgets/dropdown-menu/templates/dropdown-item"],function(e,t,n,i){var s=Backbone.Model.extend({defaults:function(){return{selected:!1,href:void 0,description:void 0,navEvent:void 0,pubsubEvent:void 0,section:void 0,hideIfNoItemsSelected:!1}}}),o=Backbone.Collection.extend({initialize:function(e,t){this.on("change:selected",this.removeOtherSelected)},model:s,removeOtherSelected:function(e,t){!1!==t&&this.each(function(t){t!==e&&t.set("selected",!1)})}}),l=e.ItemView.extend({events:{click:"setSelected"},setSelected:function(e){return this.model.set("selected",!0),!1},template:i,onRender:function(){this.setElement(this.el.innerHTML)}}),d=Backbone.Model.extend({defaults:function(){return{selectedOption:!1,selectedPapers:!1,onlySelected:!0}}}),c=e.CompositeView.extend({initialize:function(e){e=e||{}},modelEvents:{"change:selectedOption":"render","change:selectedPapers":"render"},collectionEvents:{"change:selected":function(){this.$el.removeClass("open")}},className:"btn-group dropdown-widget s-dropdown-widget",childView:l,childViewContainer:".link-container",template:n,serializeData:function(){var t=this.model.toJSON();return t.btnType=e.getOption(this,"btnType")||"btn-default",t.dropdownTitle=e.getOption(this,"dropdownTitle"),t.iconClass=e.getOption(this,"iconClass"),t.pullRight=e.getOption(this,"rightAlign"),t},events:{"change input.papers":function(e){"all"==$(e.target).attr("value")?this.model.set("onlySelected",!1):this.model.set("onlySelected",!0)},"click .dropdown-menu label":function(e){e.stopPropagation&&e.stopPropagation()}},onRender:function(){this.$(".dropdown-helper-icon").off().click(function(e){window.open(e.currentTarget.href,"_blank")})}});return t.extend({initialize:function(e){var t=this;if(this.options=_.defaults(e,{updateLinks:_.noop}),!this.options.links)throw new Error("Dropdown menu will be empty!");this.model=new d({selectedOption:this.options.selectedOption}),this.collection=new o(this.options.links),this.view=new c(_.extend({collection:this.collection,model:this.model},this.options)),this.listenTo(this.collection,"change:selected",function(e,n){if(e.has("navEvent"))t.emitNavigateEvent(e,n);else if(e.has("pubsubEvent")){var i=t.getOnlySelected();t.getPubSub().publish(t.getPubSub().CUSTOM_EVENT,e.get("pubsubEvent"),{onlySelected:i})}e.set("selected",!1)})},activate:function(e){_.bindAll(this),this.setBeeHive(e);var t=this.getPubSub();t.subscribe(t.STORAGE_PAPER_UPDATE,this.onStoragePaperChange),t.subscribe(t.USER_ANNOUNCEMENT,this.updateFromUserData),this.updateFromUserData()},getUserData:function(){try{var e=_.isFunction(this.getBeeHive)&&this.getBeeHive(),t=_.isFunction(e.getObject)&&e.getObject("User");return _.isPlainObject(t)?_.isFunction(t.getUserData)&&t.getUserData("USER_DATA"):{}}catch(e){return{}}},updateFromUserData:function(){var e=this.getUserData(),t=this.options.updateLinks(e,this.options.links)||this.options.links;this.options.links=t,this.collection.reset(this.options.links)},onStoragePaperChange:function(e){this.model.set("selectedPapers",!!e)},getOnlySelected:function(){return this.model.get("selectedOption")&&this.model.get("selectedPapers")&&this.model.get("onlySelected")},emitNavigateEvent:function(e,t){var n=this.getOnlySelected();if(t){var i=_.extend({onlySelected:n},e.get("params"));this.getPubSub().publish(this.getPubSub().NAVIGATE,e.get("navEvent"),i)}e.set("selected",!1)}})});