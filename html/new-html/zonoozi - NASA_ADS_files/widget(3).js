define(["d3","marionette","js/widgets/base/base_widget","js/components/api_request","hbs!js/widgets/bubble_chart/templates/container","hbs!js/widgets/bubble_chart/templates/tooltip","js/components/api_targets","js/components/api_query_updater","js/components/api_query"],function(e,t,a,s,i,l,n,c,r){var o=Backbone.Model.extend({initialize:function(e){var t=this;this.on("change:solrData",function(){_.isEmpty(t.get("solrData"))?t.reset(!1):(t.set("loading",!1),t.modifyData())})},modifyData:function(){var e,t;if(!_.isEmpty(this.get("solrData"))){var a=[];_.each(this.get("solrData"),function(e,t){try{e.pubdate=e.pubdate.replace(/(\D)00/g,function(e,t){return t+"01"}),e.date=new Date(e.pubdate),e.year=parseInt(e.bibcode.slice(0,4)),e.citation_count=e.citation_count?e.citation_count:0,e.read_count=e.read_count?e.read_count:0,e.title=e.title?e.title[0]:"",e.pub=e.bibcode.slice(4,9).replace(/\./g,""),a.push(e)}catch(t){console.warn(e,"didn't get added to bibcode list for some reason")}}),e=_.chain(a).pluck("pub").countBy(function(e){return e}).pairs().sortBy(function(e){return e[1]}).value().reverse();var s=0;_.each(e.slice(0,5),function(e){s+=e[1]}),s/a.length>=.25?(t=_.map(e,function(e){return e[0]}).slice(0,5),s/a.length<1&&t.push("other"),this.set("journalNames",t)):this.set("journalNames",[]),this.set("modifiedSolrData",a)}},reset:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.set(this.defaults(),{silent:e})},toggleTracked:function(e){var t=this.get("trackingBibs");_.contains(t,e)?this.set("trackingBibs",_.without(t,e)):(t.push(e),this.set("trackingBibs",t))},defaults:function(){return{solrData:{},modifiedSolrData:[],currentGraphData:{},yScale:"log",xScale:"linear",yLogPossible:!0,xLogPossible:!1,xValue:"date",yValue:"read_count",radius:"citation_count",journalNames:[],trackingBibs:[],selectedBibs:[],timeRange:"year",currentPub:void 0,loading:!0}}}),u=t.ItemView.extend({className:"bubble-chart s-bubble-chart",template:i,reset:function(){this.scales={},this.cache={}},modelEvents:{"change:modifiedSolrData":"render","change:currentPub":"rearrangeGraph","change:yScale":"rearrangeGraph","change:xScale":"rearrangeGraph","change:selectedBibs":"manageSubmitButton"},events:{"click .graph-select":function(e){var t=$(e.currentTarget);this.$(".graph-select").removeClass("active"),t.hasClass("reads-vs-time")?this.model.set({radius:"citation_count",xScale:"linear",xValue:"date",yValue:"read_count",yScale:"log"},{silent:!0}):t.hasClass("citations-vs-time")?this.model.set({radius:"read_count",xValue:"date",xScale:"linear",yValue:"citation_count",yScale:"log"},{silent:!0}):t.hasClass("reads-vs-citations")&&this.model.set({radius:"year",yValue:"read_count",xValue:"citation_count",xScale:"log"},{silent:!0}),this.rearrangeGraph(),t.addClass("active")},"click .submit":function(){this.trigger("filterBibs",this.model.get("selectedBibs"))},"click .close":function(){this.trigger("close-widget")}},getConfig:function(){this.config={},this.config.margin={left:80,bottom:40,right:20,top:60},this.config.height=500-(this.config.margin.top+this.config.margin.bottom),this.config.width=1e3-(this.config.margin.left+this.config.margin.right),this.config.animationLength=t.getOption(this,"testing")?0:500},cacheVals:function(){this.cache={},this.cache.svg=e.select(this.$("svg.bubble-chart-svg")[0]).append("g").attr("transform","translate("+this.config.margin.left+","+this.config.margin.top+")"),this.cache.realSvg=e.select(this.$("svg.bubble-chart-svg")[0]),this.cache.tooltip=e.select(this.$(".d3-tooltip")[0])},setScales:function(){this.scales={};var t,a,s,i=this.model.get("currentGraphData"),l=this,n=[];if(this.model.get("journalNames").length&&(this.scales.journalScale=e.scale.ordinal().domain(this.model.get("journalNames")).range(["hsla(282, 80%, 52%, 1)","hsla(1, 80%, 51%, 1)","hsla(152, 80%, 40%, 1)","hsla(193, 80%, 48%, 1)","hsla(220, 80%, 56%, 1)","hsla(0, 0%, 20%, 1)"])),"date"===l.model.get("xValue")){var c;if((t=e.extent(i,function(e){return e.date}))[1].getFullYear()-t[0].getFullYear()>2)this.model.set("timeRange","year"),(c=new Date(t[0])).setMonth(c.getMonth()-12),n.push(c),(c=new Date(t[1])).setMonth(c.getMonth()+12),n.push(c);else this.model.set("timeRange","month"),(c=new Date(t[0])).setMonth(c.getMonth()-1),n.push(c),(c=new Date(t[1])).setMonth(c.getMonth()+1),n.push(c);this.scales.xScale=e.time.scale().domain(n).range([0,l.config.width])}else"citation_count"==l.model.get("xValue")&&(s=e.extent(i,function(e){return e[l.model.get("xValue")]}),"log"===l.model.get("xScale")?this.scales.xScale=e.scale.log().domain(s).range([0,l.config.width]):this.scales.xScale=e.scale.linear().domain(s).range([0,l.config.width]));a=e.extent(i,function(e){return e[l.model.get("yValue")]}),"log"===this.model.get("yScale")?this.scales.yScale=e.scale.log().domain(a).range([l.config.height,0]):this.scales.yScale=e.scale.linear().domain(a).range([l.config.height,0]),"year"==l.model.get("radius")?this.scales.radiusScale=e.scale.linear().domain(e.extent(i,function(e){return e[l.model.get("radius")]})).range([2,14]):this.scales.radiusScale=e.scale.linear().domain(e.extent(i,function(e){return e[l.model.get("radius")]})).range([4,26])},finalProcess:function(){var t,a,s=this,i=this.model.get("modifiedSolrData");t=e.sum(_.pluck(i,s.model.get("yValue"))),a=e.sum(_.pluck(i,s.model.get("xValue"))),t?this.model.set("yLogPossible",!0):(this.model.set("yScale","linear",{silent:!0}),this.model.set("yLogPossible",!1)),a?this.model.set("xLogPossible",!0):(this.model.set("xScale","linear",{silent:!0}),this.model.set("xLogPossible",!1)),i=_.chain(i).filter(function(e){return"linear"===s.model.get("yScale")||(!!e[s.model.get("yValue")]||void 0)}).filter(function(e){return"linear"===s.model.get("xScale")||(!!e[s.model.get("xValue")]||void 0)}).sortBy(function(e){return-e[s.model.get("radius")]}).value(),this.model.set("currentGraphData",i),this.setScales()},resetSelection:function(){this.model.set("selectedBibs",[]),this.cache.svg.selectAll(".paper-circle.selected").classed("selected",!1),this.cache.svg.select("rect.selection").remove()},rearrangeGraph:function(){this.finalProcess(),this.resetSelection();var t,a,s,i,l,n=this.cache.svg,c=this.cache.realSvg,r=this.model.get("journalNames"),o=this;c.select("rect.selection").remove(),t=this.model.get("currentGraphData"),(i=o.model.get("currentPub"))&&(t=_.filter(t,function(e){return"other"===i?!_.contains(o.model.get("journalNames"),e.pub):e.pub===i})),a=e.svg.axis().scale(this.scales.yScale).orient("left").ticks(10).tickFormat(e.format("s")),l="date"===this.model.get("xValue")&&"year"==this.model.get("timeRange")?e.time.format("%Y"):"date"===this.model.get("xValue")&&"month"==this.model.get("timeRange")?e.time.format("%b-%Y"):e.format(""),xAxis=e.svg.axis().scale(this.scales.xScale).orient("bottom").tickFormat(l),n.select(".y-axis").transition().duration(o.config.animationLength).call(a),n.select(".x-axis").transition().duration(o.config.animationLength).call(xAxis),this.renderLabels(c.select(".y-label"),c.select(".x-label")),(s=n.selectAll(".paper-circle").data(t,function(e){return e.bibcode})).exit().remove(),s.transition().duration(o.config.animationLength).attr("r",function(e){return o.scales.radiusScale(e[o.model.get("radius")])+"px"}).attr("cy",function(e){return o.scales.yScale(e[o.model.get("yValue")])}).attr("cx",function(e){return o.scales.xScale(e[o.model.get("xValue")])}),s.enter().append("circle").classed("paper-circle",!0).classed("tracked",function(e){return!!_.contains(o.model.get("trackingBibs"),e.bibcode)}).attr("cx",function(e){return o.scales.xScale(e[o.model.get("xValue")])}).style("fill",function(e){if(r&&_.contains(r,e.pub))return o.scales.journalScale(e.pub)}).attr("cy",function(e){return o.scales.yScale(e[o.model.get("yValue")])}).attr("r",function(e){return o.scales.radiusScale(e[o.model.get("radius")])+"px"}),s.order()},onRender:function(){_.isEmpty(this.model.get("modifiedSolrData"))?this.model.set("loading",!0):this.renderGraph()},renderLabels:function(e,t){var a=this;function s(e,t){e.append("circle").classed("scale-choice",!0).classed("log",!0).classed("selected",function(){if("log"===a.model.get(t))return!0}).attr("r","6px").attr("cx",200).attr("cy",-10),e.append("text").attr("x",210).attr("y",-5).text("log").classed("log",!0),e.append("circle").classed("scale-choice",!0).classed("linear",!0).classed("selected",function(){if("linear"===a.model.get(t))return!0}).attr("r","6px").attr("cx",250).attr("cy",-10),e.append("text").attr("x",260).attr("y",-5).text("linear")}e.selectAll("*").remove(),e.append("text").text(function(){return"citation_count"===a.model.get("yValue")?"Citation Count":"read_count"===a.model.get("yValue")?"90 Day Read Count":void 0}).classed("axis-title",!0),e.call(s,"yScale"),t.selectAll("*").remove(),t.append("text").text(function(){return"citation_count"===a.model.get("xValue")?"Citation Count":"date"===a.model.get("xValue")?"Date":void 0}).classed("axis-title",!0),"date"!==a.model.get("xValue")&&t.call(s,"xScale"),this.attachLogLinearEventListeners(),this.model.get("yLogPossible")||(e.selectAll(".scale-choice").classed("hidden",!0),e.selectAll("text.log").classed("hidden",!0)),this.model.get("xLogPossible")||(t.selectAll(".scale-choice").classed("hidden",!0),t.selectAll("text.log").classed("hidden",!0))},attachLogLinearEventListeners:function(){var t=this.cache.realSvg,a=this;_.each([{container:".y-label",scale:"yScale"},{container:".x-label",scale:"xScale"}],function(s){t.selectAll(s.container+" .scale-choice").on("click",function(t){e.selectAll(s.container+" .scale-choice").classed("selected",!1);var i=e.select(this);i.classed("linear")?(a.model.set(s.scale,"linear"),i.classed("selected",!0)):(a.model.set(s.scale,"log"),i.classed("selected",!0))},this)})},renderGraph:function(){this.getConfig(),this.cacheVals(),this.finalProcess();var t,a,s,i,n,c=this.cache.svg,r=this.cache.realSvg,o=this,u=o.model.get("journalNames"),d=!1;t=this.model.get("currentGraphData"),s="year"==this.model.get("timeRange")?e.svg.axis().scale(this.scales.xScale).orient("bottom").tickFormat(e.time.format("%Y")):e.svg.axis().scale(this.scales.xScale).orient("bottom").tickFormat(e.time.format("%b-%Y")),n=e.svg.axis().scale(this.scales.yScale).orient("left").tickFormat(e.format("s")),r.attr("aria-label","bubble chart"),c.append("g").attr("class","x-axis").attr("transform","translate(0,"+o.config.height+")").call(s),c.append("g").attr("class","y-axis").call(n),i=r.append("g").attr("transform","translate(35, 400) rotate(-90)").classed("y-label",!0),a=r.append("g").attr("transform","translate("+o.config.width/2+","+(o.config.height+o.config.margin.top+o.config.margin.bottom+10)+")").classed("x-label",!0),this.renderLabels(i,a),c.selectAll(".paper-circle").data(t).enter().append("circle").classed("paper-circle",!0).attr("r",function(e){return o.scales.radiusScale(e.citation_count)+"px"}).attr("cx",function(e){return o.scales.xScale(e.date)}).attr("cy",function(e){return o.scales.yScale(e.read_count)}).style("fill",function(e){if(u&&_.contains(u,e.pub))return o.scales.journalScale(e.pub)});var h=r.append("g").classed("journal-name-key",!0).attr("transform","translate("+(o.config.width+o.config.margin.right+o.config.margin.left)+","+(o.config.height/2-o.config.margin.top)+")");h.selectAll("rect").data(u).enter().append("rect").attr("width",13).attr("height",13).attr("y",function(e,t){return 22*t}).attr("fill",function(e){return"other"===e?"hsla(0, 0%, 20%, 1)":o.scales.journalScale(e)}),h.selectAll("text").data(u).enter().append("text").attr("x",15).attr("y",function(e,t){return 22*t+10}).text(function(e){return e}).on("click",function(t){var a=e.select(this);1==a.classed("journal-selected")?(a.classed("journal-selected",!1),o.model.set("currentPub",void 0)):(r.selectAll(".journal-selected").classed("journal-selected",!1),a.classed("journal-selected",!0),o.model.set("currentPub",t))}),r.on("click.tracking",function(t,a){if(e.select(e.event.target).classed("paper-circle")){var s=e.event.target.__data__.bibcode;o.model.toggleTracked(s),_.contains(o.model.get("trackingBibs"),s)?e.select(e.event.target).classed("tracked",!0):e.select(e.event.target).classed("tracked",!1)}}),r.on("mouseover.tooltip",function(t){if(e.select(e.event.target).classed("paper-circle")&&!d){var a,s,i,n,c=o.model.get("yValue"),r=o.model.get("xValue"),u=o.model.get("radius"),h=e.mouse(this.parentElement)[0],g=e.mouse(this.parentElement)[1],m={},f=e.event.target.__data__;n=e.mouse(this.parentElement)[0]-o.config.margin.left>500?"right":"left",(a=e.selectAll(".paper-circle").filter(function(e){if(e[c]==f[c]&&e[r]==f[r])return!0}).sort(function(e,t){return t[u]-e[u]}).data()).length>3&&(m.extra=a.length-3,a=a.slice(0,3)),m.bibs=a,o.cache.tooltip.html(l(m)),o.cache.tooltip.style({visibility:"hidden",display:"block"}),s=e.select(".d3-tooltip")[0][0].clientHeight,i=e.max([2.5*parseInt(e.select(e.event.target).attr("r")),10]),"left"===n?o.cache.tooltip.style("left",h+i+"px").style("top",g-s/2+"px").style("visibility","visible"):o.cache.tooltip.style("left",h-i-240+"px").style("top",g-s/2+"px").style("visibility","visible")}}),r.on("mousemove.tooltip",function(t){e.event.target.classList.contains("paper-circle")||o.cache.tooltip.style({display:"none"})}),r.on("mousedown.select",function(){if(e.event.target===e.event.currentTarget){d=!0,c.selectAll(".paper-circle.selected").classed("selected",!1),r.select("rect.selection").remove();var t=e.mouse(this);r.append("rect").attr({rx:6,ry:6,class:"selection",x:t[0],y:t[1],width:0,height:0})}}).on("mousemove.select",function(){if(d){var t=r.select("rect.selection");if(!t.empty()){var a=e.mouse(this),s={x:parseInt(t.attr("x"),10),y:parseInt(t.attr("y"),10),width:parseInt(t.attr("width"),10),height:parseInt(t.attr("height"),10)},i={x:a[0]-s.x,y:a[1]-s.y};if(s.width=i.x,s.height=i.y,i.x<0||i.y<0)return;t.attr(s),r.selectAll(".paper-circle").each(function(t,a){var i=e.select(this),l=parseInt(i.attr("cx")),n=parseInt(i.attr("cy"));l+o.config.margin.left>=s.x&&l+o.config.margin.left<=s.x+s.width&&n+o.config.margin.top>=s.y&&n+o.config.margin.top<=s.y+s.height?i.classed("selected",!0):i.classed("selected",!1)})}}}).on("mouseup.select",function(){d=!1;var e=[];c.selectAll(".paper-circle.selected").each(function(t){"none"!==this.style.display&&e.push(t.bibcode)}),o.model.set("selectedBibs",e)})},manageSubmitButton:function(){0===this.model.get("selectedBibs").length?this.$(".submit").addClass("disabled"):this.$(".submit").removeClass("disabled")}});return a.extend({initialize:function(e){var t=this;e=e||{},this.model=new o,this.view=new u({model:this.model,testing:e.testing}),this.listenTo(this.view,"filterBibs",this.onFilterBibs),this.listenTo(this.view,"close-widget",function(){t.resetModel(),t.broadcastClose()}),this.widgetName="bubble_chart",this.queryUpdater=new c(this.widgetName)},activate:function(e){this.setBeeHive(e),_.bindAll(this,"setCurrentQuery","processResponse");var t=this.getPubSub();t.subscribe(t.INVITING_REQUEST,this.setCurrentQuery),t.subscribe(t.DELIVERING_RESPONSE,this.processResponse),this.getBeeHive().getObject("AppStorage")&&this.setCurrentQuery(this.getBeeHive().getObject("AppStorage").getCurrentQuery())},resetModel:function(){this.model.reset(!1)},renderWidgetForListOfBibcodes:function(e){this.resetModel();var t=new r;t.unlock(),t.set("q","bibcode:("+e.join(" OR ")+")"),t.set("rows",n._limits.BubbleChart.default),t.set("fl","title,bibcode,citation_count,read_count,pubdate");var a=new s({target:n.SEARCH,query:t});this.getPubSub().publish(this.getPubSub().DELIVERING_REQUEST,a)},renderWidgetForCurrentQuery:function(){this.resetModel();var e=this.getCurrentQuery().clone();e.unlock(),e.set("rows",n._limits.BubbleChart.default),e.set("fl","title,bibcode,citation_count,read_count,pubdate"),e.unset("hl"),e.unset("hl.fl");var t=new s({target:n.SEARCH,query:e});this.getPubSub().publish(this.getPubSub().DELIVERING_REQUEST,t)},processResponse:function(e){this.model.reset(),this.view.reset(),this.model.set("solrData",e.get("response.docs"))},onFilterBibs:function(){var e=this.model.get("selectedBibs"),t=this.getCurrentQuery().clone();if(e.length){var a=this.queryUpdater,s="bibcode:("+e.map(function(e){return a.quoteIfNecessary(e)}).join(" OR ")+")";t.unlock(),this._updateFq(t,s);var i=this.getPubSub();i.publish(i.NAVIGATE,"search-page",{q:t})}},_updateFq:function(e,t){var a="fq_"+this.widgetName;e.unset(a),this.queryUpdater.updateQuery(e,a,"limit",t);var s="{!type=aqp v=$"+a+"}",i=e.get("fq");i?(-1==_.indexOf(i,s)&&i.push(s),e.set("fq",i)):e.set("fq",[s])},broadcastClose:function(){this.getPubSub().publish(this.getPubSub().NAVIGATE,"results-page")}})});