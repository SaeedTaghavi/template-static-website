define(["marionette","js/widgets/base/base_widget","js/components/api_response","js/components/json_response","js/components/api_request","js/components/api_query","js/mixins/dependon","hbs!js/widgets/citation_helper/templates/citation_helper_template","bootstrap","js/components/api_feedback","js/components/api_targets","analytics"],function(e,t,i,s,n,r,o,a,d,l,u,c){var b=Backbone.Model.extend({defaults:{items:[],widgetName:"CitationHelper",libraryID:null,permission:null,libname:null}}),p=e.ItemView.extend({template:a,events:{"click .close-widget":"signalCloseWidget","click .submit-add-to-library":"libraryAdd"},modelEvents:{change:"render"},libraryAdd:function(){this.$(".submit-add-to-library").html('<i class="fa fa-spinner fa-pulse"></i>');var e={};e.libraryID=this.model.get("libraryID"),e.libname=this.model.get("libname");var t=this.$("input:checked").map(function(){return this.value}).get();e.recordsToAdd=t,this.trigger("library-add",e)},signalCloseWidget:function(){this.trigger("close-widget")}}),g=t.extend({viewEvents:{"close-widget":"closeWidget","library-add":"libraryAddSubmit"},initialize:function(t){t=t||{},this.model=new b,this.view=new p({model:this.model}),e.bindEntityEvents(this,this.view,e.getOption(this,"viewEvents"))},activate:function(e){this.setBeeHive(e),_.bindAll(this,"setCurrentQuery","processResponse");var t=e.getService("PubSub");t.subscribe(t.INVITING_REQUEST,this.setCurrentQuery),t.subscribe(t.DELIVERING_RESPONSE,this.processResponse),this.getBeeHive().getObject("AppStorage")&&this.setCurrentQuery(this.getBeeHive().getObject("AppStorage").getCurrentQuery())},libraryAddSubmit:function(e){var t={},i=this;t.library=e.libraryID,t.bibcodes=e.recordsToAdd,name=e.libname,this.getBeeHive().getObject("LibraryController").addBibcodesToLib(t).done(function(t,s){var n=t.numBibcodesRequested-parseInt(t.number_added);i.model.set("feedback",{success:!0,name:name,id:e.libraryID,numRecords:t.number_added,numAlreadyInLib:n})}).fail(function(t){i.model.set("feedback",{success:!1,name:name,id:e.libraryID,error:JSON.parse(arguments[0].responseText).error})}),this.clearFeedbackWithDelay()},clearFeedbackWithDelay:function(){var e=this;setTimeout(function(){e.model.unset("feedback")},5e3)},getSuggestions:function(e){var t=$.Deferred(),i=this.getPubSub(),s=new n({target:u.SERVICE_CITATION_HELPER,query:new r({bibcodes:e}),options:{type:"POST",contentType:"application/json"}});return i.subscribeOnce(i.DELIVERING_RESPONSE,function(e){t.resolve(e.toJSON())}),i.publish(i.EXECUTE_REQUEST,s),t.promise()},processResponse:function(e){if(e instanceof i){var t=_.map(e.get("response.docs"),function(e){return e.bibcode});this.getSuggestions(t)}else e instanceof s&&this.processSuggestions(e)},processSuggestions:function(e){(e=e.attributes?e.attributes:e).Error&&"Unable to get results!"===e.Error||500==e.status?this.model.set("msg","Citation Helper did not find any suggestions."):this.model.set("items",e)},renderWidgetForCurrentQuery:function(){this.reset(),this.dispatchRequest(this.getCurrentQuery())},reset:function(){this.model.clear({silent:!0}).set("items",[],{silent:!0})},closeWidget:function(){this.getPubSub().publish(this.getPubSub().NAVIGATE,"results-page")},renderWidgetForListOfBibcodes:function(e,t){this.reset();var i=new n({target:u.SERVICE_CITATION_HELPER,query:new r({bibcodes:e}),options:{type:"POST",contentType:"application/json"}});this.model.set({libraryID:t.libid,permission:t.permission,libname:t.libname}),this.getPubSub().publish(this.getPubSub().EXECUTE_REQUEST,i)}});return _.extend(g.prototype,o.BeeHive),g});