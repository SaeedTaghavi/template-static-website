define(["js/components/generic_module","js/mixins/dependon","js/components/api_query","js/components/api_request","js/components/api_targets","analytics"],function(e,t,r,n,s,i){var o=e.extend({initialize:function(e){this.options=_.defaults({},e,{maxQueryRows:6e3,transformDebounce:1e3}),this.options.transformDebounce&&(this.transform=_.debounce(this.transform,this.options.transformDebounce))},activate:function(e){this.setBeeHive(e.getHardenedInstance());var t=this.getBeeHive().getService("PubSub");t.subscribe(t.CUSTOM_EVENT,_.bind(this.onCustomEvent,this))},onCustomEvent:function(e){e.startsWith("second-order-search/")&&this.transform.apply(this,[e.split("/")[1]].concat(_.rest(arguments)))},getSelectedIds:function(){var e=this.getBeeHive().getObject("AppStorage");return e&&e.getSelectedPapers&&e.getSelectedPapers()||[]},getCurrentQuery:function(){var e=this.getBeeHive().getObject("AppStorage");if(e&&e.getCurrentQuery&&e.getCurrentQuery()instanceof r)return e.getCurrentQuery()},getBigQueryResponse:function(e){var t=this.getPubSub(),i=$.Deferred(),o=new r({bigquery:"bibcode\n".concat(e.join("\n")),q:"*:*",fq:"{!bitset}",sort:"date desc"}),a=new n({target:s.MYADS_STORAGE+"/query",query:o,options:{type:"POST",done:function(e){var t=e.qid;return i.resolve(t)},fail:function(e){return i.reject(e)}}});return t.publish(t.EXECUTE_REQUEST,a),i.promise()},sendQuery:function(e){var t=this.getPubSub(),r=$.Deferred(),i=new n({target:s.SEARCH,query:e,options:{type:"GET",done:function(e){return r.resolve(e)},fail:function(e){return r.reject(e)}}});return t.publish(t.EXECUTE_REQUEST,i),r.promise()},validField:function(e){return _.contains(_.values(o.FIELDS),e)},submitAnalyticsEvent:function(e){i("send","event","interaction","second-order-operation",e)},transform:function(e,t){if(!e||!this.validField(e))throw"must pass in a valid field";var r=_.defaults({},t,{onlySelected:!1,libraryId:null,ids:[],query:null}),n=r.ids.length>0?r.ids:this.getSelectedIds();0!==n.length&&r.onlySelected||e===o.FIELDS.LIMIT||e===o.FIELDS.LIBRARY||e===o.FIELDS.EXCLUDE?e===o.FIELDS.LIBRARY?this.startSearch(e,r.libraryId):this.getQidAndStartSearch(e,n):this.transformCurrentQuery(e,r.query)},handleError:function(e){var t="Error occurred";e.responseJSON&&e.responseJSON.error&&(t=e.responseJSON.error);var r=this.getPubSub();throw r.publish(r.CUSTOM_EVENT,"second-order-search/error",{message:t}),t},transformCurrentQuery:function(e,t){var n=this.getPubSub(),s=t instanceof r?t:this.getCurrentQuery();if(s){var i=s.clone(),o=[];o.push(i.get("q")),_.forEach(Object.keys(i.toJSON()),function(e){e.startsWith("fq_")&&o.push(i.get(e))});var a=new r({q:"".concat(e,"(").concat(o.join(" AND "),")"),sort:"score desc"});n.publish(n.NAVIGATE,"search-page",{q:a})}},getQidAndStartSearch:function(e,t){var r=this;this.getBigQueryResponse(t).then(function(t){r.startSearch(e,t)}).fail(function(){return r.handleError.apply(r,arguments)})},startSearch:function(e,t){if(!t)throw"no id";var n;if(e===o.FIELDS.LIMIT){var s=this.getCurrentQuery()||new r;n=new r({q:"docs(".concat(t,")"),sort:s.get("sort")||"score desc"})}else if(e===o.FIELDS.LIBRARY)n=new r({q:"docs(library/".concat(t,")"),sort:"date desc"});else if(e===o.FIELDS.EXCLUDE){var i=this.getCurrentQuery()||new r;(n=i.clone()).set({q:"-docs(".concat(t,") ").concat(i.get("q"))})}else n=new r({q:"".concat(e,"(docs(").concat(t,"))"),sort:"score desc"});var a=this.getPubSub();a.publish(a.NAVIGATE,"search-page",{q:n}),this.submitAnalyticsEvent(e)}});return o.FIELDS={USEFUL:"useful",SIMILAR:"similar",TRENDING:"trending",REVIEWS:"reviews",LIMIT:"limit",LIBRARY:"library",EXCLUDE:"exclude"},_.extend(o.prototype,t.BeeHive),o});