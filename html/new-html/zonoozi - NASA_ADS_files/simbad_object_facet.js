define(["js/components/api_response","js/components/api_request","js/components/api_query","js/components/solr_response","js/widgets/facet/factory","js/components/api_targets","analytics","cache","underscore","js/widgets/facet/reducers"],function(e,t,i,s,a,c,r,n,o,u){return function(){var e=a.makeHierarchicalCheckboxFacet({facetField:"simbad_object_facet_hier",facetTitle:"SIMBAD Objects",logicOptions:{single:["limit to","exclude"],multiple:["and","or","exclude"]}});return e._dispatchRequest=function(e,t){var i=this.getPubSub(),s=this,a=this.getBeeHive();this.store.dispatch(this.actions.data_requested(e)),e?i.subscribeOnce(i.DELIVERING_RESPONSE,function(t){s.translateSimbid(t,e)}):i.subscribeOnce(i.DELIVERING_RESPONSE,function(t){s.store.dispatch(s.actions.data_received(t.toJSON(),e))});var c=this.getCurrentQuery();if(o.isUndefined(c)&&a.hasObject("AppStorage")){var r=a.getObject("AppStorage");o.isFunction(r.getCurrentQuery)&&(c=r.getCurrentQuery())}var n=this.customizeQuery(c);t=(e?this.store.getState().facets[e].children:this.store.getState().children).length||0;n.set("facet.offset",t),e&&n.set("facet.prefix",e.replace("0/","1/"));var u=this.composeRequest(n);i.publish(i.DELIVERING_REQUEST,u)},e._simbidCache={},e.translateSimbid=function(i,s){var a=this,r=i.toJSON().facet_counts.facet_fields.simbad_object_facet_hier.map(function(e,t){if(t%2==0)return e.split("/")[e.split("/").length-1]}).filter(function(e){if(e)return e});var n=new t({target:c.SERVICE_OBJECTS,options:{type:"POST",contentType:"application/json",data:JSON.stringify({identifiers:r}),done:function(t){var c=i.toJSON();c.facet_counts.facet_fields.simbad_object_facet_hier=c.facet_counts.facet_fields.simbad_object_facet_hier.map(function(i,s){if(s%2==0){var a=i.split("/"),c=a[a.length-1],r=a.slice(0,2).concat([t[c].canonical]).join("/");return e._simbidCache[r]=c,r}return i},this),a.store.dispatch(a.actions.data_received(c,s))}}}),o=this.getPubSub();o.publish(o.EXECUTE_REQUEST,n)},e.submitFilter=function(e){var t=this.getCurrentQuery().clone();t.unlock();var i=this.store.getState().config.facetField,s="fq_"+i,a=u.getActiveFacets(this.store.getState(),this.store.getState().state.selected),c=a.map(function(e){if(this._simbidCache[e])var t=e.split("/").slice(0,2).concat([this._simbidCache[e]]).join("/");else t=e;return i+':"'+t+'"'},this);"and"==e||"limit to"==e?this.queryUpdater.updateQuery(t,s,"limit",c):"or"==e?this.queryUpdater.updateQuery(t,s,"expand",c):"exclude"!=e&&"not"!=e||(t.get(s)?this.queryUpdater.updateQuery(t,s,"exclude",c):(c.unshift("*:*"),this.queryUpdater.updateQuery(t,s,"exclude",c)));var n="{!type=aqp v=$"+s+"}",f=t.get("fq")||[];if(f.push(n),t.set("fq",o.unique(f)),"simbad_object_facet_hier"===i){var d=o.find(o.keys(t.toJSON()),function(e){return e.match(/fq_simbad_object_facet_hier/i)});if(d){var _=t.get(d)[0];t.set("filter_simbad_object_facet_hier_fq_simbad_object_facet_hier",[_].concat(a)),t.unset("__simbad_object_facet_hier_fq_simbad_object_facet_hier")}}t.unset("facet.prefix"),t.unset("facet"),t.unset("start"),t.unset("rows"),this.dispatchNewQuery(t),r("send","event","interaction","facet-applied",JSON.stringify({name:i,logic:e,conditions:c}))},e}});