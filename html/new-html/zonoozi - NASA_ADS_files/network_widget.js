define(["marionette","d3","js/components/api_targets","js/mixins/user_change_rows","js/components/api_request","js/components/api_query","js/widgets/base/base_widget","js/components/api_query_updater","hbs!js/widgets/network_vis/templates/author-details-template","hbs!js/widgets/network_vis/templates/container-template","hbs!js/widgets/network_vis/templates/filter-container-template","hbs!js/widgets/network_vis/templates/graph-container-template","hbs!js/widgets/network_vis/templates/group-details-template","hbs!js/widgets/network_vis/templates/not-enough-data-template","hbs!js/widgets/network_vis/templates/network_metadata","hbs!js/widgets/network_vis/templates/loading-template","hbs!js/widgets/network_vis/templates/default-details-template","bootstrap"],function(e,t,i,n,a,r,s,o,l,c,h,d,u,p,g,f,m){function w(e){return!isNaN(e)&&(0|(t=parseFloat(e)))===t;var t}var v=Backbone.Model.extend({defaults:{name:void 0},idAttribute:"name"}),y=Backbone.Collection.extend({model:v}),b=e.ItemView.extend({initialize:function(e){this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this.render),this.listenTo(this.collection,"reset",this.render)},serializeData:function(){var e=this,t={};return t.limit=this.collection.pluck("name"),_.each(t.limit,function(i,n){w(i)&&"author"==e.options.networkType?t.limit[n]="at least one member of Group "+i:w(i)&&"paper"==e.options.networkType&&(t.limit[n]="Group "+i)}),t},template:h,childViewContainer:".dropdown-menu",events:{"click .apply-filter":"initiateFilter","click .clear-filter":"clearFilter"},initiateFilter:function(){this.trigger("filter:initiated")},clearFilter:function(){this.collection.reset()}}),k=e.ItemView.extend({template:m,serializeData:function(){return{currentQuery:e.getOption(this,"query"),networkType:e.getOption(this,"networkType"),cachedQuery:e.getOption(this,"cachedQuery")}},getData:function(){if("author"==e.getOption(this,"networkType")){var i=[];_.each(e.getOption(this,"graphData").root.children,function(e,n){var a=n;if(!(n>6)){var r=[];_.each(e.children,function(e,t){Array.prototype.push.apply(r,e.papers)}),r=_.uniq(r);var s=_.map(r,function(e){return parseInt(e.slice(0,4))});r=_.countBy(r,function(e){return e.slice(0,4)});var o=_.range.apply(void 0,t.extent(s)),l={};_.each(o,function(e){l[e]=0}),r=_.extend(l,r),r=_.map(r,function(e,t){return{year:parseInt(t),amount:e}}),i.push({name:a,values:r})}})}else if("paper"==e.getOption(this,"networkType")){var n=e.getOption(this,"graphData").summaryGraph,a=e.getOption(this,"graphData").fullGraph,r=(i=[],{}),s=_.pluck(n.nodes,"id"),o=_.pluck(n.nodes,"node_name");_.each(s,function(e,t){var i=[];_.each(a.nodes,function(t,n){t.group===e&&i.push(t.node_name)}),r[o[t]]=i}),_.each(r,function(e,n){if(!(n>6)){o=_.uniq(e);var a=_.map(o,function(e){return parseInt(e.slice(0,4))});o=_.countBy(o,function(e){return e.slice(0,4)});var r=_.range.apply(void 0,t.extent(a)),s={};_.each(r,function(e){s[e]=0});var o=_.extend(s,o);o=_.map(o,function(e,t){return{year:parseInt(t),amount:e}}),i.push({name:parseInt(n)-1,values:o})}})}return i},onRender:function(){var e=this.getData(),i=!0;if(_.each(e,function(e){1!==e.values.length&&(i=!1)}),i){var n=e[0].values[0].year;this.$(".time-series-container").html("Not enough data to show a graph: All papers are from the year "+n)}else{var a=[],r=[];_.each(e,function(e){_.each(e.values,function(e){a.push(e.year),r.push(e.amount)})}),a=_.uniq(a);var s=20,o=80,l=30,c=50,h=960-c-o,d=500-s-l,u=t.scale.linear().range([0,h]),p=t.scale.linear().range([d,0]),g=t.svg.axis().scale(u).orient("bottom").tickFormat(t.format("0f")).ticks(5);a.length<=10&&g.tickValues(a);var f=t.svg.axis().scale(p).tickFormat(t.format("d")).orient("left"),m=t.svg.line().interpolate("bundle").x(function(e){return u(e.year)}).y(function(e){return p(e.amount)}),w=t.select(this.$("svg")[0]).attr("width",h+c+o).attr("height",d+s+l).attr("style","font-family:helvetica,arial,san-serif").attr("id","network-viz-time-series").append("g").attr("transform","translate("+c+","+s+")"),v=t.scale.ordinal().domain([0,1,2,3,4,5,6]).range(["hsla(282, 80%, 52%, 1)","hsla(1, 80%, 51%, 1)","hsla(42, 97%, 48%, 1)","hsla(152, 80%, 40%, 1)","hsla(193, 80%, 48%, 1)","hsla(220, 80%, 56%, 1)","hsla(250, 69%, 47%, 1)"]);u.domain(t.extent(a)),p.domain([0,_.max(r)]),w.attr("aria-label","author network graph").append("g").attr("class","axis").attr("transform","translate(0,"+d+")").call(g),w.append("g").attr("class","axis").call(f);var y=w.selectAll(".group").data(e).enter().append("g").attr("class","group");y.append("path").attr("class","line").attr("d",function(e){return m(e.values)}).style("stroke",function(e){return v(e.name)}),y.append("text").datum(function(e){return{name:e.name,value:e.values[e.values.length-1]}}).attr("transform",function(e){return"translate("+u(e.value.year)+","+p(e.value.amount)+")"}).attr("x",3).attr("dy",".35em").text(function(e){return e.name+1});i=_.filter(e,function(e){if(1==e.values.length)return!0});w.selectAll(".one-year").data(i).enter().append("circle").classed("one-year",!0).attr("r",5).attr("cx",function(e){return u(e.values[0].year)}).attr("cy",function(e){return p(e.values[0].amount)}).attr("fill",function(e){return v(e.name)})}}}),x=e.ItemView.extend({template:c,className:function(){return"network-widget s-network-widget "+e.getOption(this,"networkType")},serializeData:function(t){var i=e.getOption(this,"networkType");return{networkType:i=i[0].toUpperCase()+i.slice(1),helpText:e.getOption(this,"helpText")}},ui:{filterContainer:".network-filter-container",graphContainer:".graph-container",detailsContainerSelected:".details-container #selected-item",detailsContainerHome:".details-container #home"},events:{"click .load-author-network":"forwardNewQueryRequest","click button.limit":"addItem","click .submit-rows":"changeRows","click .close":"triggerClose","click .filter-remove":function(t){if("paper"==e.getOption(this,"networkType")){var i=this.graphModel.get("selectedEntity").__data__.data.node_name;e.getOption(this,"filterCollection").remove({id:i}),this.graphView.showSelectedEntity(this.graphModel.get("selectedEntity"))}else{i=this.graphModel.get("selectedEntity").__data__.name;e.getOption(this,"filterCollection").remove({id:i}),this.showDetailView(this.graphModel.get("selectedEntity"))}},"click .filter-add":function(t){if("paper"==e.getOption(this,"networkType")){var i=this.graphModel.get("selectedEntity").__data__.data.node_name;e.getOption(this,"filterCollection").add({name:i}),this.graphView.showSelectedEntity(this.graphModel.get("selectedEntity"))}else{var n=[],a=this.graphModel.get("selectedEntity").__data__;a.papers?n=a.papers:_.each(a.children,function(e){[].push.apply(n,e.papers)}),e.getOption(this,"filterCollection").add({name:a.name,papers:n}),this.showDetailView(this.graphModel.get("selectedEntity"))}}},triggerClose:function(){this.$(".network-filter-container").empty(),this.$(".network-container").html(f),this.trigger("close")},forwardNewQueryRequest:function(e){this.ui.graphContainer.html(f()),this.trigger("new-network-requested",$(e.target).data("query"))},changeRows:function(e){var t=parseInt(this.$(".network-rows").val());if(_.isNumber(t)){var i=_.min([this.model.get("max"),t]);if(this.model.get("userVal")===i)return!1;this.$(".network-container").html(f),this.model.set("userVal",i)}return!1},modelEvents:{"change:graphData":"render","change:max":"renderMetadata","change:current":"renderMetadata"},onRender:function(){var t,i;try{i=this.model.get("cachedQuery").get("q")[0]}catch(e){}return this.model.get("loading")?(this.$(".network-metadata").html(""),void this.$(".network-container").html(f())):!this.model.get("graphData")||_.isEmpty(this.model.get("graphData"))?(this.$(".network-metadata").html(""),void this.$(".network-container").html(p({cachedQuery:i}))):this.model.get("graphData").summaryGraph||this.model.get("graphData").root?(this.graphModel=new T({graphData:this.model.get("graphData")}),this.filterView=new b({collection:e.getOption(this,"filterCollection"),networkType:e.getOption(this,"networkType")}),this.listenTo(this.filterView,"filter:initiated",function(){this.trigger("filter:initiated")}),t=this.options.graphView?this.options.graphView:V,this.graphView=new t({model:this.graphModel,filterCollection:e.getOption(this,"filterCollection")}),this.graphView.on("show-detail-view",_.bind(this.showDetailView,this)),this.ui.filterContainer.append(this.filterView.render().el),this.ui.graphContainer.append(this.graphView.render().el),this.ui.detailsContainerHome.append(new k({graphData:this.model.get("graphData"),query:this.model.get("query"),networkType:e.getOption(this,"networkType"),cachedQuery:i}).render().el),this.$(".nav-tabs a[href='#home']").tab("show"),void this.renderMetadata()):(this.$(".network-metadata").html(""),void this.$(".network-container").html(p({cachedQuery:i})))},showDetailView:function(i){var n=i.__data__;(i=t.select(i)).select(".node-label").classed("selected-label",!0),i.select(".node-path").classed("selected-node",!0);var a,r=[],s={},o=[],c=this.model.get("graphData");if(n.children){a=n.children,_.each(a,function(e){Array.prototype.push.apply(r,e.papers)});g=_.sortBy(r,function(e){return e.slice(0,4)}).reverse()[0].slice(0,4);r=_.pairs(_.countBy(r));var h=_.chain(r).map(function(e){return e[1]}).sortBy(function(e){return e}).value(),d=_.chain(r).map(function(e){return e[1]/c.bibcode_dict[e[0]].authors.length}).sortBy(function(e){return e}).value(),p=_.chain(r).map(function(e){return c.bibcode_dict[e[0]].citation_count/c.bibcode_dict[e[0]].authors.length}).sortBy(function(e){return e}).value();r=_.sortBy(r,function(e){return(e[1]-h[0])/(h[h.length-1]-h[0])*(e[1]/c.bibcode_dict[e[0]].authors.length-d[0])/(d[d.length-1]-d[0])*(c.bibcode_dict[e[0]].citation_count/c.bibcode_dict[e[0]].authors.length-p[0])/(p[p.length-1]-p[0])}).reverse(),bibcodes=_.map(r,function(e){return e[0]}),o=_.map(bibcodes,function(e,t){var i={};return i.bibcode=e,i.title=c.bibcode_dict[e].title,i.citation_count=c.bibcode_dict[e].citation_count,i.numAuthors=r[t][1],i}),s.bibcodes=bibcodes,s.papers=o,s.groupColor=n.color,s.total=r.length,s.mostRecentYear=g,s.name=n.name,s.inFilter=!!e.getOption(this,"filterCollection").get(n.name),this.ui.detailsContainerSelected.empty().append(u(s))}else{o=_.map(n.papers,function(e){var t=c.bibcode_dict[e];return t.bibcode=e,_.isArray(t.title)&&(t.title=t.title[0]),t}),o=_.sortBy(o,function(e){return e.citation_count}).reverse();var g=_.chain(o).pluck("bibcode").sortBy(function(e){return e.slice(0,4)}).value().reverse()[0].slice(0,4);s.bibcodes=n.papers,s.mostRecentYear=g,s.papers=o,s.total=o.length,s.name=n.name,s.groupColor=n.parent.color,s.inFilter=!!e.getOption(this,"filterCollection").get(n.name),s.dataQuery='author:"'+n.name+'"',this.ui.detailsContainerSelected.empty().append(l(s))}this.$(".nav-tabs a[href='#selected-item']").tab("show")},renderMetadata:function(){var e={};e.max=this.model.get("max"),e.current=this.model.get("current"),this.$(".network-metadata").html(g(e))}}),E=n.Model.extend({initialize:function(e){e=e||{};if(this.on("newMetadata",function(){this.updateCurrent(),this.updateMax()}),!e.widgetName)throw new Error("need to configure with widget name so we can get limit/default info from api_targets._limits");var t={graphData:{},rows:void 0,numFound:void 0,current:void 0,max:void 0,userVal:void 0,cachedQuery:void 0,loading:!0};_.extend(t,i._limits[e.widgetName]),this.defaults=function(){return t},this.set(this.defaults())}}),V=e.ItemView.extend({initialize:function(e){this.listenTo(e.filterCollection,"reset",this.showSelectedEntity)},template:d,events:{"change input[name=mode]":function(e){this.model.set("mode",e.target.value)},"change input[name=show-link]":function(e){this.model.set("linkLayer",e.target.checked)}},modelEvents:{"change:graphData":"renderGraph","change:selectedEntity":"showSelectedEntity","change:linkLayer":"changeLinkLayer","change:mode":"changeMode"},onRender:function(){this.model.get("graphData")&&this.renderGraph()},getConfig:function(){this.config={numberOfLabelsToShow:100,width:900,height:900,noGroupColor:"#a6a6a6"},this.config.radius=Math.min(this.config.width,this.config.height)/3},cachedVals:{partition:void 0,line:void 0,computeLabelPosition:void 0,svg:void 0,arc:void 0},renderGraph:function(){var e=this.model.get("graphData"),i=this;function n(e){var n=(e.x+e.x+e.dx)/2*180/Math.PI-90,a=parseInt(i.config.radius)+10,r=n>90?180:0;return r?t.select(this).attr("text-anchor","end"):t.select(this).attr("text-anchor","start"),"rotate("+n+")translate("+a+")rotate("+r+")"}this.cachedVals.svg=t.select(this.$("svg")[0]),this.getConfig(),this.customizeScales(e),this.cachedVals.computeLabelPosition=n;var a=i.cachedVals.svg.attr("width",i.config.width).attr("height",i.config.height).append("g").classed("network-g",!0),r=a.append("g").classed("real-container-of-stuff",!0),s=t.behavior.zoom().scaleExtent([.7,3]).on("zoom",function(){r.attr("transform","translate("+t.event.translate+")scale("+t.event.scale+")")});a.call(s),a.on("dblclick.zoom",null),a.attr("transform","translate("+i.config.width/2+","+i.config.height/2.1+")");var o=t.layout.partition().value(function(e){return e.size}).size([2*Math.PI,i.config.radius*i.config.radius]).sort(function(e,t){return t.value-e.value});this.cachedVals.partition=o;var l=t.svg.arc().startAngle(function(e){return e.x}).endAngle(function(e){return e.x+e.dx}).innerRadius(function(e){return 1==e.depth?Math.sqrt(e.y)+40:Math.sqrt(e.y)}).outerRadius(function(e){return Math.sqrt(e.y+e.dy)});this.cachedVals.arc=l,r.append("circle").attr("r",i.config.radius).attr("fill","#fff").style("cursor","move");var c=r.selectAll("g").data(o.nodes(e.root)).enter().append("g").classed("node-containers",!0).each(function(e){e.sortVal=e.value}),h={};c.append("path").attr("d",l).classed("node-path",function(e){return 0!=e.depth}).style("cursor",function(e){if(0==e.depth)return"move"}).style("fill",function(e){if(0==e.depth)return"white";if(1==e.depth){var t=e.parent.children.indexOf(e);return t<7?(e.color=i.scales.color(t),h[e.name]=e.color,e.color):i.config.noGroupColor}return 2==e.depth?e.parent.color?e.parent.color:i.config.noGroupColor:void 0}).each(function(e){e.x0=e.x,e.dx0=e.dx});c.filter(function(e){return!e.children}).classed("author-node",!0).append("text").text(function(e){return e.name}).classed("node-label",!0).on("mouseover",function(e){if(i.model.get("linkLayer")){var n=e;t.selectAll(".link").filter(function(e){if(e[0]==n||e[e.length-1]==n)return!0}).classed("selected-link",!0),t.selectAll(".link").each(function(e){e[0]==n?t.selectAll(".node-label").filter(function(t){return t.name==e[e.length-1].name}).classed("linked-label",!0):e[e.length-1]==n&&t.selectAll(".node-label").filter(function(t){return t.name==e[0].name}).classed("linked-label",!0)})}}).on("mouseout",function(){t.selectAll(".link").classed("selected-link",!1),t.selectAll(".node-label").classed("linked-label",!1)}).attr("font-size",function(e){return i.scales.occurrencesFontScale(e.size)+"px"}).attr("transform",n),_.each(e.root.name,function(t,i){r.append("text").classed("s-connector-node",!0).attr("y",function(){return 25*i-25*e.root.name.length/2}).text(t.nodeName)}),c.on("click",function(e,t){0!=e.depth&&(i.model.get("linkLayer")||(i.model.get("selectedEntity")===this?i.model.set("selectedEntity",null):i.model.set("selectedEntity",this)))}),this.renderLinkLayer()},renderLinkLayer:function(){var e,i,n,a,r=this;svg=t.select(r.$(".real-container-of-stuff")[0]),tooltip=t.select(r.$(".d3-tooltip")[0]),bibDict=this.model.get("graphData").bibcode_dict,e=_.map(r.model.get("graphData").link_data,function(e){var t={};return t.source=svg.selectAll(".node-path").filter(function(t){return t.numberName==e[0]})[0][0].__data__,t.target=svg.selectAll(".node-path").filter(function(t){return t.numberName==e[1]})[0][0].__data__,t.weight=e[2],t}),i=t.layout.bundle(),n=t.svg.line.radial().interpolate("bundle").tension(.9).radius(function(e){return Math.sqrt(e.y+e.dy)}).angle(function(e){return(e.x+e.x+e.dx)/2}),this.cachedVals.line=n,(a=svg.append("g").classed("link-container",!0)).append("circle").attr("r",r.config.radius).classed("link-background",!0),a.selectAll(".link").data(i(e)).enter().append("path").attr("class","link").attr("d",function(e){return n(e)}).attr("stroke-width",function(t){var i=_.filter(e,function(e){return e.source==t[0]&&e.target==t[t.length-1]||e.target==t[0]&&e.source==t[t.length-1]})[0].weight;return r.scales.linkScale(i)})},customizeScales:function(e){this.scales={},this.scales.color=t.scale.ordinal().domain([0,1,2,3,4,5,6]).range(["hsla(282, 60%, 52%, 1)","hsla(349, 61%, 47%, 1)","hsla(26, 95%, 67%, 1)","hsla(152, 60%, 40%, 1)","hsla(193, 64%, 61%, 1)","hsla(220, 70%, 56%, 1)","hsla(250, 50%, 47%, 1)"]);var i=[],n=[],a=[];_.each(e.root.children,function(e){_.each(e.children,function(e){i.push(e.size),n.push(e.citation_count),a.push(e.read_count)})}),n=_.sortBy(n,function(e){return e}).reverse(),a=_.sortBy(a,function(e){return e}).reverse(),this.scales.citationLimit=n[this.config.numberOfLabelsToShow]||n[n.length-1],this.scales.readLimit=a[this.config.numberOfLabelsToShow]||a[a.length-1],this.scales.occurrencesFontScale=t.scale.log().domain([t.min(i),t.max(i)]).range([8,20]),this.scales.citationFontScale=t.scale.linear().domain([t.min(n),t.max(n)]).range([8,20]),this.scales.readFontScale=t.scale.linear().domain([t.min(a),t.max(a)]).range([8,20]);var r=_.map(e.link_data,function(e){return e[2]});this.scales.linkScale=t.scale.pow().exponent(8).domain([t.min(r),t.max(r)]).range([.5,3.5])},showSelectedEntity:function(){var e=this.model.get("selectedEntity"),t=this.$(".network-detail-area");this.cachedVals.svg.selectAll(".node-path").classed("selected-node",!1),this.cachedVals.svg.selectAll(".node-label").classed("selected-label",!1),t.empty(),e&&this.trigger("show-detail-view",e)},changeLinkLayer:function(e,i){i?(this.model.set("cachedEntity",this.model.get("selectedEntity")),this.model.set("selectedEntity",void 0),t.select(this.$(".link-container")[0]).style("display","block").selectAll(".link").call(function(e){3e3/e[0].length}).sort(function(e){return e.weight}).style("display","block")):(this.model.set("selectedEntity",this.model.get("cachedEntity")),t.select(this.$(".link-container")[0]).style("display","none"))},changeMode:function(e,i){var n=this;var a=n.cachedVals.svg.selectAll(".node-containers"),r=n.cachedVals.partition.sort(function(e,t){return t.sortVal-e.sortVal}).value(function(e){return e[i]}).nodes(n.model.get("graphData").root);a.data(r,function(e){return e.name}).selectAll("path").transition().duration(1500).attrTween("d",function(e){var i=t.interpolate({x:e.x0,dx:e.dx0},e);return function(t){var a=i(t);return e.x0=a.x,e.dx0=a.dx,n.cachedVals.arc(a)}}),a.selectAll("text").attr("opacity","0").attr("display",function(e){return"size"==i?"block":"citation_count"==i&&e.citation_count>n.scales.citationLimit?"block":"read_count"==i&&e.read_count>n.scales.readLimit?"block":"none"}).attr("font-size",function(e){return"size"==i?n.scales.occurrencesFontScale(e.size)+"px":"citation_count"==i?n.scales.citationFontScale(e.citation_count)+"px":"read_count"==i?n.scales.readFontScale(e.read_count)+"px":void 0}).attr("transform",n.cachedVals.computeLabelPosition).transition().duration(1500).attr("opacity",1),t.selectAll(".link").transition().duration(1500).attr("d",function(e){return n.cachedVals.line(e)})}}),T=Backbone.Model.extend({defaults:function(){return{graphData:{},selectedEntity:void 0,cachedEntity:void 0,query:void 0,linkLayer:!1,mode:"occurrences"}}});return s.extend({initialize:function(e){if(!e.endpoint)throw new Error("widget was not configured with an endpoint");e.broadcastFilteredQuery&&(this.broadcastFilteredQuery=e.broadcastFilteredQuery),this.model=new E({widgetName:e.widgetName||"AuthorNetwork"}),this.listenTo(this.model,"change:userVal",this.requestDifferentRows),this.filterCollection=new y,this.view=new x({graphView:e.graphView,model:this.model,filterCollection:this.filterCollection,networkType:e.networkType,helpText:e.helpText,graphMixin:e.graphMixin,showDetailGraphView:e.showDetailGraphView}),this.listenTo(this.view,"new-network-requested",this.requestDifferentQuery),this.listenTo(this.view,"filter:initiated",this.broadcastFilteredQuery),this.listenTo(this.view,"close",this.broadcastClose),this.widgetName="visualization_"+e.networkType,this.queryUpdater=new o(this.widgetName)},generateApiRequest:function(t){return new a({target:e.getOption(this,"endpoint"),query:new r({query:JSON.stringify(t.toJSON())}),options:{type:"POST",contentType:"application/json"}})},requestDifferentRows:function(e,t){var i=this.getCurrentQuery().clone();i.unlock(),i.set("rows",this.model.get("userVal")),i.unset("hl"),i.unset("hl.fl");var n=this.generateApiRequest(i);this.getPubSub().publish(this.getPubSub().EXECUTE_REQUEST,n)},requestDifferentQuery:function(e){this.model.set("cachedQuery",this.getCurrentQuery());var t=new r;t.set("q",e),t.set("rows",this.model.get("default")),t.set("sort","date desc");var i=this.generateApiRequest(t);this.setCurrentQuery(t),this.getPubSub().publish(this.getPubSub().EXECUTE_REQUEST,i)},activate:function(e){this.setBeeHive(e),_.bindAll(this,"setOriginalQuery","processResponse");var t=this.getPubSub();t.subscribe(t.INVITING_REQUEST,this.setOriginalQuery),t.subscribe(t.DELIVERING_RESPONSE,this.processResponse),this.getBeeHive().getObject("AppStorage")&&this.setOriginalQuery(this.getBeeHive().getObject("AppStorage").getCurrentQuery()),this.activateWidget(),this.attachGeneralHandler(this.onApiFeedback)},onApiFeedback:function(e){if(e.error){var t=this;setTimeout(function(){t.broadcastClose()},1e3)}},setOriginalQuery:function(e){this.model.set("cachedQuery",void 0),this._originalQuery=e,this.setCurrentQuery(e)},getOriginalQuery:function(){return this._originalQuery},resetWidget:function(){this.view&&this.view.graphView&&(this.view.$(".network-metadata").empty(),this.view.graphView.$el.empty(),this.view.graphView.stopListening()),this.filterCollection.reset(null,{silent:!0}),this.model.set(_.result(this.model,"defaults"),{silent:!0})},renderWidgetForListOfBibcodes:function(t){this.resetWidget(),this.model.set({graphData:{},loading:!0});var i=new a({target:e.getOption(this,"endpoint"),query:new r({bibcodes:t.slice(0,1e3)}),options:{type:"POST",contentType:"application/json"}});this.getPubSub().publish(this.getPubSub().EXECUTE_REQUEST,i)},renderWidgetForCurrentQuery:function(){this.resetWidget();var e=this.getCurrentQuery().clone();if(e.unlock(),e.get("__qid")){e.set("fl","bibcode"),e.set("rows","1000");var t=this.composeRequest(e);this.getPubSub().publish(this.getPubSub().DELIVERING_REQUEST,t)}else{e.set("rows",this.model.get("default")),e.unset("hl"),e.unset("hl.fl");t=this.generateApiRequest(e);this.getPubSub().publish(this.getPubSub().EXECUTE_REQUEST,t)}},processResponse:function(e){try{e.get("responseHeader.params.__qid");this.renderWidgetForListOfBibcodes(e.get("response").docs.map(function(e){return e.bibcode}))}catch(i){var t=e.toJSON();this.model.set({graphData:t.data,numFound:parseInt(t.msg.numFound),rows:parseInt(t.msg.rows),query:e.getApiQuery().get("q"),loading:!1}),this.model.trigger("newMetadata")}},broadcastFilteredQuery:function(){var e=_.flatten(this.filterCollection.pluck("papers"));this.resetWidget();var t=this.getPubSub();t.publish(t.CUSTOM_EVENT,"second-order-search/limit",{ids:e})},broadcastClose:function(){this.resetWidget(),this.getPubSub().publish(this.getPubSub().NAVIGATE,"results-page")},testing:{detailView:k}})});