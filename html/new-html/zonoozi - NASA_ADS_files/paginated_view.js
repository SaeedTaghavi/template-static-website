define(["underscore","marionette","backbone","js/components/api_request","js/components/api_query","js/widgets/base/base_widget","hbs!js/widgets/list_of_things/templates/item-template","hbs!js/widgets/list_of_things/templates/results-container-template","js/mixins/link_generator_mixin","js/mixins/add_stable_index_to_collection","hbs!js/widgets/list_of_things/templates/empty-view-template","hbs!js/widgets/list_of_things/templates/error-view-template","hbs!js/widgets/list_of_things/templates/initial-view-template","./item_view","analytics","mathjax","hbs!js/wraps/widget/loading/template"],function(e,t,s,i,o,n,r,a,g,l,h,c,d,u,p,m,b){var w=s.Model.extend({defaults:function(){return{mainResults:!1,title:void 0,showAbstract:"closed",showHighlights:!1,showSidebars:!0,pagination:!0,start:0,highlightsLoaded:!1}}}),f=function(e){var t=e.clone(),s=t.get("q");if(s[0]===s[0].toUpperCase())return t.set("q",s[0].toLowerCase()),t.unset("fl"),{url:"#search/"+t.url(),query:t.get("q")}},v=t.ItemView.extend({template:function(t){return t.query?h(t):t.error?c(t):b(e.extend(t,{widgetLoadingSize:"big",hideCloseButton:!0}))}});return t.CompositeView.extend({childView:u,emptyView:v,initialize:function(e){this.model=new w},serializeData:function(){var e=this.model.toJSON();return e.queryOperator&&(e.queryURL="#search/q="+e.queryOperator+"(",e.queryURL+=encodeURIComponent("bibcode:"+e.bibcode)+")",e.removeSelf&&(e.queryURL+=encodeURIComponent(" -bibcode:"+e.bibcode)),e.sortOrder&&(e.queryURL+="&sort="+encodeURIComponent(e.sortOrder))),e},onRender:function(){m&&m.Hub.Queue(["Typeset",m.Hub,this.el])},className:"list-of-things",alreadyRendered:!1,emptyViewOptions:function(t){var s=this.model.get("query"),i=this.model.get("isTugboat"),o=this.model.get("error");return this.model.unset("error",{silent:!0}),e.isArray(s)?t.set({query:s[0],showTugboatMessage:i,suggestedQuery:f(this.model.get("currentQuery"))}):e.has("query",s)?t.set({query:s.query[0],showTugboatMessage:i,suggestedQuery:f(this.model.get("currentQuery"))}):o&&t.set("error",o),{model:t}},childViewContainer:".results-list",events:{"click .show-highlights":"toggleHighlights","click .show-abstract":"toggleAbstract","click .toggle-sidebars":"toggleShowSidebars","click #go-to-bottom":"goToBottom","click #backToTopBtn":"goToTop","click a.page-control":"changePageWithButton","keyup input.page-control":"tabOrEnterChangePageWithInput","change #per-page-select":"changePerPage"},toggleHighlights:function(t){var s=this.model.get("showHighlights");s=e.isBoolean(s)&&s?"closed":"open"===s?"closed":"open",this.model.set("showHighlights",s),this.model.get("highlightsLoaded")||(this.model.set("highlightsLoaded",!0),this.trigger("toggle-highlights","open"===s))},toggleAbstract:function(){"open"==this.model.get("showAbstract")?this.model.set("showAbstract","closed"):"closed"==this.model.get("showAbstract")&&(this.model.set("showAbstract","open"),p("send","event","interaction","abstracts-toggled-on"))},toggleShowSidebars:function(){var e=!this.model.get("showSidebars");this.model.set("showSidebars",e),p("send","event","interaction","on")},goToBottom:function(){$("#app-container").animate({scrollTop:this.$el.outerHeight()},"fast")},goToTop:function(){$("#app-container").animate({scrollTop:0},"fast")},modelEvents:{change:"render","change:showHighlights":"toggleChildrenHighlights","change:showAbstract":"toggleChildrenAbstracts"},collectionEvents:{reset:"onResetCollection"},template:a,onResetCollection:function(){this.model.set("highlightsLoaded",!1),this.model.trigger("change:showAbstract")},toggleChildrenHighlights:function(){var e=this.model.get("showHighlights");this.collection.invoke("set","showHighlights","open"===e)},toggleChildrenAbstracts:function(){var e=this.model.get("showAbstract");this.collection.invoke("set","showAbstract","open"===e)},changePageWithButton:function(e){var t=$(e.currentTarget);if(!t.parent().hasClass("disabled")){var s=t.hasClass("next-page")?1:-1,i=this.model.get("page")+s;return this.trigger("pagination:select",i),this.resultsWidget&&p("send","event","interaction","results-list-pagination",i),!1}},tabOrEnterChangePageWithInput:function(e){var t=parseInt($(e.target).val()-1);13!=e.keyCode&&9!=e.keyCode||this.trigger("pagination:select",t),this.resultsWidget&&p("send","event","interaction","results-list-pagination",t)},changePerPage:function(e){var t=parseInt(e.currentTarget?e.currentTarget.value:25);return t!==this.model.get("perPage")&&this.trigger("pagination:changePerPage",t),!1}})});