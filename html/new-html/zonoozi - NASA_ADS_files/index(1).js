function ownKeys(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(n),!0).forEach(function(t){_defineProperty(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}define(["underscore","../models/authorAffiliation","../constants/actionNames","filesaver"],function(e,t,n){var r=function(e,t,n){return[].concat(_toConsumableArray(e.slice(0,t)),[n],_toConsumableArray(e.slice(t+1)))},a=e.memoize(function(e){return e.map(function(e,t){return _objectSpread({},e,{selected:!0,affiliations:e.affiliations.map(function(e,t){return _objectSpread({},e,{selected:0===t})}),lastActiveDates:e.lastActiveDates.map(function(e,t){return _objectSpread({},e,{selected:0===t})})})})},function(){return 0}),o=e.memoize(function(e,t){return e.map(function(e){return _objectSpread({},e,{selected:t,affiliations:e.affiliations.map(function(e){return _objectSpread({},e,{selected:t})}),lastActiveDates:e.lastActiveDates.map(function(e,n){return _objectSpread({},e,{selected:t&&0===n})})})})},function(e,t){return t}),i={appReset:function(){return function(e){return e({type:n.appReset})}},reset:function(){return function(e,t){var r=t().data;e({type:n.setData,value:a(r)})}},toggleAll:function(){return function(e,t){var r=t(),a=r.data,i=r.toggle;e({type:n.setData,value:o(a,i)}),e({type:n.setToggle})}},setAffiliationData:function(r){return function(a){r=e(r).groupBy("authorName").map(function(e,n){return t.create(n,e)}).value(),a({type:n.setData,value:r})}},closeWidget:function(){return function(e,t,n){n.closeWidget()}},showMessage:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"success",r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5e3;return function(o,i){0!==a&&e.delay(function(){o({type:n.setMessage,value:{show:!1}}),o({type:n.setShowReload,value:!1})},a),i().exporting||o({type:n.setShowReload,value:"danger"===t}),o({type:n.setMessage,value:{type:t,message:r,show:!0}})}},_reload:e.debounce(function(e,t){var n=e().ids;t.fetchAffiliationData(n)},500),reload:function(){return function(e,t,n){i._reload(t,n)}},updateYear:function(e){return function(t,r,a){var o=r();try{e=Number(e)}catch(t){e=o.year}t({type:n.setYear,value:e}),a.fetchAffiliationData(o.ids,e,o.author)}},updateAuthor:function(e){return function(t,r,a){var o=r();try{e=Number(e)}catch(t){e=o.author}t({type:n.setAuthor,value:e}),a.fetchAffiliationData(o.ids,o.year,e)}}};return i.toggleSelection=function(t,a){return function(o,i){var c=i().data,s=-1,u=-1,l=[],f=e.indexOf(c,t);a&&(s=e.indexOf(t.affiliations,a),u=e.indexOf(t.lastActiveDates,a)),l=s>=0?function(t,n,a,o,i){var c=r(t[a].affiliations,n,_objectSpread({},i,{selected:!i.selected})),s=e.any(c,{selected:!0})||e.any(t[a].lastActiveDates,{selected:!0});return r(t,a,_objectSpread({},o,{selected:s,affiliations:c}))}(c,s,f,t,a):u>=0?function(t,n,a,o,i){var c=e.findIndex(t[n].lastActiveDates,{selected:!0}),s=r(t[n].lastActiveDates,a,_objectSpread({},o,{selected:!o.selected}));c>=0&&(s=r(s,c,_objectSpread({},s[c],{selected:!1})));var u=e.any(s,{selected:!0})||e.any(t[n].affiliations,{selected:!0});return r(t,n,_objectSpread({},i,{selected:u,lastActiveDates:s}))}(c,f,u,a,t):f>=0?function(e,t,n){return r(e,t,_objectSpread({},n,{selected:!n.selected,affiliations:n.selected?e[t].affiliations.map(function(e){return _objectSpread({},e,{selected:!1})}):e[t].affiliations,lastActiveDates:n.selected?e[t].lastActiveDates.map(function(e){return _objectSpread({},e,{selected:!1})}):e[t].lastActiveDates}))}(c,f,t):c,o({type:n.setData,value:l})}},i.doExport=function(){return function(t,r,a){var o,c,s=r(),u=s.data,l=s.format,f=function(e){switch(/\[(.*)]/.exec(e)[1]){case"csv":return{ext:"csv",type:"text/csv"};case"excel":return{ext:"xls",type:"application/vnd.ms-excel"};case"browser":return{ext:"browser",type:"text/plain"};default:return{ext:"txt",type:"text/plain"}}}(l);t({type:n.setExporting,value:!0}),a.exportAffiliationData({selected:(o=u,c=[],e.forEach(o,function(t){var n=[];if(t.selected){var r=e.find(t.lastActiveDates,{selected:!0});r=r?r.date:" ";var a=e.filter(t.affiliations,{selected:!0});e.isEmpty(a)&&c.push([t.author," ",r].join("|")),e.forEach(a,function(e){e.selected&&(n.push(t.author),n.push(e.name),n.push(r),c.push(n.join("|")))})}}),c),format:l}).done(function(e){"browser"===f.ext?(e.text().then(function(e){return t=e,(n=window.open()).document.write(t),void n.focus();var t,n}),t(i.showMessage("info","If new tab doesn't appear, you will need to allow popups"))):(e.blob().then(function(e){return saveAs(e,"authorAffiliations.".concat(f.ext))}),t(i.showMessage("success","Export Successful!")))}).fail(function(){i.showMessage("danger","Something happened with the request, please try again")}).always(function(){return t({type:n.setExporting,value:!1})}),i.showMessage("info","Exporting...")}},i});