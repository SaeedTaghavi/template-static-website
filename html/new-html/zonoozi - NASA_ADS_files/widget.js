define(["underscore","jquery","backbone","marionette","js/components/api_query","js/components/pubsub_events","hbs!js/widgets/filter_visualizer/templates/widget-view","hbs!js/widgets/filter_visualizer/templates/item-view","js/components/api_feedback","js/mixins/dependon"],function(e,t,r,a,i,n,o,s,l,c){var f=r.Model.extend({}),u=r.Collection.extend({model:f}),p=a.ItemView.extend({tagName:"span",className:"filter-topic-group",template:s,events:{"click button":"onClick"},onClick:function(e){var r=t(e.target);return this.trigger("filter-event",r.attr("value")?r.attr("value"):r.parent().attr("value")),!1}}),h=a.CompositeView.extend({template:o,childView:p,childViewContainer:"#filter-visualizer",events:{}}),_=a.Controller.extend({activate:function(t){e.bindAll(this,"processFeedback","onFilterEvent"),this.setBeeHive(t),pubsub=t.getService("PubSub"),pubsub.subscribe(pubsub.FEEDBACK,this.processFeedback)},initialize:function(t){t=e.defaults(t,{withoutOperators:!0,maxNumberOfTokens:5,maxQueryLen:100}),this.collection=new u({}),this.view=new h({collection:this.collection}),this.listenTo(this.view,"childview:filter-event",this.onFilterEvent),this.knownFilters={fq_aff:"Affiliations",fq_author:"Author",fq_database:"Collection",fq_property:"Property",fq_facets180:"Status",fq_keyword_facet:"Keywords",fq_bibstem_facet:"Publication",fq_bibgroup_facet:"BibGroup",fq_data_facet:"Data",fq_vizier_facet:"Vizier",fq_simbad_object_facet_hier:"Object",fq_ned_object_facet_hier:"Object",fq_grant:"Grant",fq_visualization_author:"Author Network",fq_visualization_paper:"Paper Network",fq_wordcloud:"Concept Cloud",fq_bubble_chart:"Results Graph",fq_doctype:"Pubtype"},this.currentQuery=null,this.withoutOperators=t.withoutOperators,this.maxNumberOfTokens=t.maxNumberOfTokens,this.maxQueryLen=t.maxQueryLen},render:function(){return this.view.render(),this.view.el},processFeedback:function(e){switch(e.code){case l.CODES.SEARCH_CYCLE_STARTED:this.processQuery({numFound:e.numFound,q:e.query.clone()})}},processQuery:function(e){var t=e.q;numFound=e.numFound;var r=this.extractFilters(t);this._saveInfo(t,r);var a=this.prepareGUIData(r);this.collection.reset(a)},_saveInfo:function(t,r){this.currentQuery=t,this.currentFilters={},e.each(r,function(e){this.currentFilters[e.filter_name]=e},this)},extractFilters:function(t){var r=t.toJSON(),a=[];if(!r.fq&&!t.get("__qid"))return a;r.fq;var i=e.keys(r);return e.each(i,function(t){if(0==t.indexOf("fq_")){if(!this.knownFilters[t])return;var n={category:this.knownFilters[t],filter_name:t,filter_query:r[t][0]};if(r[t].length>1)return void console.warn("Breach of an api contract, filter contains too many values",t,r[t]);var o=e.filter(i,function(e){if(e.indexOf(t)>-1&&e!==t)return!0});1==o.length?(n.filter_key=o[0],n.filter_value=r[o[0]]):console.warn("no fq metadata available, so presumably query is being loaded from url (if not, there is a problem!) "),a.push(n)}},this),a=e.sortBy(a,function(t){var r=e.indexOf(self.knownFilters,t.category);return r>-1?r:1e3})},prepareGUIData:function(t){if(this.withoutOperators)return this._prepareGUIDataWithoutOperators(t);var r=[];return e.each(t,function(t){var a=[];if(a.push({type:"category",display:t.category,value:t.filter_name+"|category|"+t.category}),t.filter_value.length-1>this.maxNumberOfTokens||t.filter_value.join(" ").length>this.maxQueryLen)return a.push({type:"control",display:t.filter_value.length-1+" custom values",value:t.filter_name+"|control|x"}),void r.push({elements:a});var i=0,n=t.filter_value[0];e.each(t.filter_value.slice(1),function(e){++i>1&&a.push({type:"operator",display:n,value:t.filter_name+"|operator|"+n}),a.push({type:"operand",display:this.beautifyOperand(t.filter_name,e),value:t.filter_name+"|operand|"+e})},this),a.push({type:"control",display:"",value:t.filter_name+"|control|x"}),r.push({elements:a})},this),r},_prepareGUIDataWithoutOperators:function(t){var r=[];return e.each(t,function(t){var a=[];if(a.push({type:"category",display:t.category,value:t.filter_name+"|category|"+t.category}),!t.filter_value||t.filter_value.length-1>this.maxNumberOfTokens||t.filter_value.join(" ").length>this.maxQueryLen)return a.push({type:"operand",display:"custom filter",value:t.filter_name+"|control|x"}),void r.push({elements:a});var i=0,n=t.filter_value[0],o="";"NOT"==n?o="-":"AND"==n&&(o="+"),e.each(t.filter_value.slice(1),function(s){var l=e.clone(a),c=0==i++&&"NOT"==n?"":o;l.push({type:"operand",display:c+this.beautifyOperand(t.filter_name,s),value:t.filter_name+"|operand|"+s}),r.push({elements:l})},this)},this),r},beautifyOperand:function(e,t){for(var r=t;0==r.indexOf("(")&&r.indexOf(")")==r.length-1;)r=r.substr(1,r.length-2);switch(r=r.replace(/0\/|1\/[^/]+\//,""),e){case"fq_author":r=(r=r.replace(/author_facet_hier:/g,"")).replace(/\d+\//g,"");break;case"fq_aff":r=(r=r.replace(/aff_facet_hier:/g,"")).replace(/\d+\//g,"");break;case"fq_database":r=r.replace(/database:/g,"");break;case"fq_facets180":r=r.replace(/property:/g,"");break;case"fq_keyword_facet":r=(r=r.replace(/keyword_facet:/g,"")).replace(/\\/g,"");break;case"fq_bibstem_facet":r=r.replace(/bibstem_facet:/g,"");break;case"fq_bibgroup_facet":r=r.replace(/bibgroup_facet:/g,"");break;case"fq_data_facet":r=r.replace(/data_facet:/g,"");break;case"fq_vizier_facet":r=r.replace(/vizier_facet:/g,"");break;case"fq_grant":r=r.replace(/grant:/g,"");break;case"fq_simbad_object_facet_hier":r=r.replace(/simbad_object_facet_hier:0\\\//g,"");break;case"fq_ned_object_facet_hier":r=r.replace(/ned_object_facet_hier:0\\\//g,"");break;case"fq_doctype":r=r.replace(/doctype:/g,"")}return r=(r=r.replace(/\\?"/g,"")).replace(/\*:\*/,"any")},createModifiedQuery:function(t){var r=t.split("|"),a={};a.name=r[0],a.part=r[1],a.value=r[2];var n=this.currentQuery.toJSON();if(n.fq||n.fq[a.name]){switch(a.part){case"operand":if(n[this.currentFilters[a.name].filter_key].length>2){var o,s=n[this.currentFilters[a.name].filter_key];if(-1==e.indexOf(s,a.value))throw console.error("Cannot find/remove the value: "+a.value,s),Error("Error in modifying the query");if((s=e.reject(s,function(e){return e==a.value})).length>2){var l=" "+s[0]+" ";o="("+s.slice(1).join(l)+")"}else o=s[1];n[a.name]=o,n[this.currentFilters[a.name].filter_key]=s;break}case"control":delete n[a.name],delete n[this.currentFilters[a.name].filter_key],n.fq=e.filter(n.fq,function(e){if(-1==e.indexOf("v=$"+a.name))return!0})}return n.fq&&0==n.fq.length&&delete n.fq,new i(n)}console.error("The current query has no filter: "+a.name)},onLoad:function(e){this.collection?this.collection.reset(this.getData(e)):this.initialize(e)},onFilterEvent:function(e,t){var r=this.createModifiedQuery(t),a=this.getBeeHive().getService("PubSub");a&&a.publish(a.NAVIGATE,"search-page",{q:r})}});return e.extend(_.prototype,c.BeeHive),_});