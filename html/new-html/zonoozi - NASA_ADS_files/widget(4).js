define(["jquery","backbone","marionette","d3","js/components/api_request","js/widgets/base/base_widget","hbs!js/widgets/wordcloud/templates/wordcloud-template","hbs!js/widgets/wordcloud/templates/selected-list-template","js/components/api_targets","js/components/api_query_updater","js/components/api_query","js/components/api_feedback","jquery-ui","bootstrap","d3-cloud"],function(e,t,i,s,r,o,n,l,a,d,u,c){var h=t.Model.extend({initialize:function(){this.on("selected",function(e){this.add(e)}),this.on("unselected",function(e){this.remove(e)})},add:function(e){this.get("selectedWords").push(e),this.trigger("userChange:selectedWords",e)},remove:function(e){e=e.trim();var t=_.without(this.get("selectedWords"),e);this.set("selectedWords",t),this.trigger("userChange:selectedWords",e)},reset:function(){this.set("selectedWords",[])},defaults:{selectedWords:[]}}),g=t.View.extend({initialize:function(e){e=e||{},this.model=new h,this.listenTo(this.model,"userChange:selectedWords",this.render)},template:l,render:function(){return this.$el.html(this.template(this.model.toJSON())),this},events:{"click .close":"removeWord","click .apply-vis-facet":"submitFacet"},removeWord:function(t){var i=e(t.target).parent().find(".selected-word").text();this.model.remove(i)},submitFacet:function(){this.model.get("selectedWords").length&&this.trigger("submitFacet")}}),p=i.ItemView.extend({className:"s-wordcloud-widget clearfix",events:{"click .close-widget":"signalCloseWidget"},initialize:function(e){e=e||{},this.listView=e.listView,this.listenTo(this.model,"change:processedWordList",this.onProcessedWordChange),this.listenTo(this.listView.model,"userChange:selectedWords",this.toggleHighlight)},signalCloseWidget:function(){this.trigger("close-widget")},toggleHighlight:function(e){var t=e.trim();s.selectAll(this.$("text")).filter(function(){if(this.textContent.trim()==t){var e=s.select(this);e.classed("selected",!e.classed("selected"))}})},template:n,render:function(){return this.$el.html(n({helpText:"<p>This word cloud allows you to view interesting words from the titles and abstracts of your search results.</p><p> Move the slider towards <strong> Frequent</strong> to view a word cloud that is simply composed of the words that appeared most frequently in your results. (This word cloud is likely to feature generic terms like 'observations' prominently.) </p> <p>Move the slider towards <strong>Unique</strong> to see a word cloud that shows words that appeared in your results but which appear very rarely in the rest of the ADS corpus.</p><p>To facet your ADS search, select words from the word cloud and click the 'Apply Filter to Search' button.</p>",loading:this.model.get("processedWordList").length<=0})),this.listView.setElement(this.$(".selected-word-list")).render(),this.$(".icon-help").popover({trigger:"hover",placement:"right",html:!0}),this},onProcessedWordChange:function(){this.render(),this.model.get("processedWordList").length>0&&(this.buildSlider(),this.buildCloudLayout())},buildCloudLayout:function(){s.layout.cloud().size([1e3,600]).words(this.model.get("processedWordList")).padding(3).rotate(function(){return 0}).font("Arial").fontSize(function(e){return e.size}).on("end",_.bind(this.draw,this)).start()},buildSlider:function(){var t=this;this.$("#word-choice").slider({value:t.model.get("currentSliderVal"),min:1,max:5,step:1,slide:function(e,i){t.model.set({currentSliderVal:i.value})},create:function(t){e("a",t.target).attr("href","javascript:void(0)").attr("aria-label","slider handle")}})},draw:function(){var e=this,t=this.model.get("renderVals"),i=s.select(this.$("#wordcloud-svg")[0]),r=this.model.get("processedWordList");if(this.$("#words-group").length)o=s.select(this.$("#wordcloud-svg")[0]).select("#words-group");else{var o=i.attr("aria-label","wordcloud chart").append("g").attr("id","words-group").attr("width",1e3).attr("height",600).attr("transform",function(){return"translate(500 300)"});i[0][0].addEventListener("click",function(t){var i=t.target.classList;i.contains("s-wordcloud-text")&&(i.contains("selected")?e.listView.model.trigger("unselected",t.target.textContent):e.listView.model.trigger("selected",t.target.textContent))})}var n=o.selectAll("text").data(r,function(e){return e.text}),l=this.listView.model.get("selectedWords");n.enter().append("text").classed("s-wordcloud-text",!0).text(function(e){return e.text}).style("fill",function(e,i){return t.fill(e.origSize)}).classed("selected",function(e,t){if(_.contains(l,e.text))return!0}).attr("transform",function(e,t){return t<15?"translate("+[1e3*Math.random(),-300]+")":t<30?"translate("+[1e3*Math.random(),300]+")":t<45?"translate("+[-500,600*+Math.random()]+")":"translate("+[500,600*-Math.random()]+")"}),n.exit().style("opacity",0).remove();e=this;n.attr("font-size",function(e){return e.size}).style("fill",function(e,i){return t.fill(e.origSize)}).transition().duration(1e3).attr("transform",function(e){return"translate("+[e.x,e.y]+")"})}}),f=t.Model.extend({initialize:function(){var e=this;this.on("change:tfidfData",function(t){return t.has("tfidfData")?e.buildWCDict():e.reset(!1)}),this.on("change:currentSliderVal",this.buildWCDict)},defaults:{tfidfData:void 0,currentSliderVal:3,processedWordList:[],renderVals:{fill:void 0,glowScale:void 0,blur:void 0},colorRange:["#80E6FF","#7575FF","#7575FF","#47008F"],sliderRange:{1:[1,0],2:[.75,.25],3:[.5,.5],4:[.25,.75],5:[0,1]}},reset:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.set(this.defaults,{silent:e})},buildWCDict:function(){var e,t,i,r,o,n,l,a,d,u,c,h,g;e=this.get("tfidfData"),t=_.size(e),i=_.reduce(_.map(_.values(e),function(e){return e.total_occurrences}),function(e,t){return e+t},0)/t,r=_.reduce(_.map(_.values(e),function(e){return e.idf?e.idf:0}),function(e,t){return e+t},0)/t,a=this.get("sliderRange"),d=this.get("currentSliderVal"),o=_.map(e,function(e,t){return u=e.total_occurrences/i,c=e.idf/r,[t,a[d][0]*c+a[d][1]*u||0]}),o=_.last(_.sortBy(o,function(e){return e[1]}),50),o=_.object(o),n=_.min(_.values(o)),l=_.max(_.values(o)),h=[],(g={}).fill=s.scale.log().domain([n,l]),g.fill.domain([0,.25,.5,.75,1].map(g.fill.invert)).range(this.get("colorRange")).clamp(!0);var p=s.scale.log().domain([n,l]).range([30,70]);for(var f in o)h.push({text:f,size:p(o[f]),select:!1,origSize:o[f]});this.set("renderVals",g),this.set("processedWordList",h)}});return o.extend({initialize:function(e){e=e||{},this.listView=new g,this.model=new f,this.view=new p({model:this.model,listView:this.listView}),this.max_rows=a._limits.ConceptCloud.limit,this.on("all",this.onAllInternalEvents),this.listenTo(this.listView,"all",this.onAllInternalEvents),this.listenTo(this.view,"close-widget",_.bind(this.closeWidget,this)),this.widgetName="wordcloud",this.queryUpdater=new d(this.widgetName)},activate:function(e){_.bindAll(this,"setCurrentQuery","processResponse"),this.setBeeHive(e);var t=this.getPubSub();t.subscribe(t.INVITING_REQUEST,this.setCurrentQuery),t.subscribe(t.DELIVERING_RESPONSE,this.processResponse),this.getBeeHive().getObject("AppStorage")&&this.setCurrentQuery(this.getBeeHive().getObject("AppStorage").getCurrentQuery())},renderWidgetForCurrentQuery:function(){this.model.unset("tfidfData");var e=this.getCurrentQuery(),t=this;if(e.get("__qid"))setTimeout(function(){t.getPubSub().publish(t.getPubSub().ALERT,new c({code:c.CODES.ALERT,msg:"The concept cloud endpoint cannot handle such a large query at this time",modal:!0}),1)});else{var s=new r({target:i.getOption(this,"endpoint")||a.SERVICE_WORDCLOUD,query:this.customizeQuery(e),options:{type:"POST",contentType:"application/json"}});this.getPubSub().publish(this.getPubSub().DELIVERING_REQUEST,s)}},renderWidgetForListOfBibcodes:function(e){this.model.unset("tfidfData"),e=e.slice(0,100);var t=new u;t.unlock(),t.set("q","bibcode:("+e.join(" OR ")+")"),t.set("rows",this.max_rows);var s=new r({target:i.getOption(this,"endpoint")||a.SERVICE_WORDCLOUD,query:new u({query:JSON.stringify(t.toJSON())}),options:{type:"POST",contentType:"application/json"}});this.getPubSub().publish(this.getPubSub().EXECUTE_REQUEST,s)},customizeQuery:function(e){var t=e.clone();t.unlock(),this.defaultQueryArguments&&(t=this.composeQuery(this.defaultQueryArguments,t));var i=this.max_rows;return t.has("rows")&&(i=t.get("rows")[0]),t.set("rows",Math.min(i,this.max_rows)),t},processResponse:function(e){try{e.get("responseHeader.params.__qid");this.renderWidgetForListOfBibcodes(e.get("response").docs.map(function(e){return e.bibcode}))}catch(t){data=e.toJSON(),this.model.set("tfidfData",data)}},close:function(){this.listView.destroy(),this.view.destroy(),i.Controller.prototype.destroy.apply(this,arguments)},setCurrentQuery:function(){this.listView.model.reset(),this.model.reset(),o.prototype.setCurrentQuery.apply(this,arguments)},onAllInternalEvents:function(e){if("submitFacet"===e){var t,i;t=this.listView.model.get("selectedWords"),(i=(i=this.getCurrentQuery()).clone()).unlock();var s=this.queryUpdater,r=t.map(function(e){return s.quoteIfNecessary(e)}).join(" OR ");this._updateFq(i,r);var o=this.getPubSub();o.publish(o.NAVIGATE,"search-page",{q:i})}},closeWidget:function(){this.getPubSub().publish(this.getPubSub().NAVIGATE,"results-page")},_updateFq:function(e,t){var i="fq_"+this.widgetName;e.unset(i),this.queryUpdater.updateQuery(e,i,"limit",t);var s="{!type=aqp v=$"+i+"}",r=e.get("fq");r?(-1==_.indexOf(r,s)&&r.push(s),e.set("fq",r)):e.set("fq",[s])}})});