define(["underscore","jquery","backbone","marionette","js/components/api_query","js/components/pubsub_events","hbs!js/widgets/api_query/templates/widget-view","hbs!js/widgets/api_query/templates/item-view","js/mixins/dependon"],function(e,t,i,n,r,u,o,a,l){var s=i.Model.extend({}),d=i.Collection.extend({model:s}),c=n.ItemView.extend({tagName:"tr",template:a,events:{"click .remove":"removeItem","blur input[name=key]":"onChange","blur input[name=value]":"onChange"},onChange:function(i){var n=t(i.target),r=e.clone(this.model.attributes),u=t(i.target).val();"key"==n.attr("name")&&r.key!=u?this.trigger("key-changed",this.model,u):"value"==n.attr("name")&&r.value!=u&&this.trigger("value-changed",this.model,u)},removeItem:function(e){return this.trigger("remove-clicked",this.model),!1}}),h=n.CompositeView.extend({template:o,childView:c,childViewContainer:"#api-query-values",events:{"click button#api-query-load":"loadApiQuery","click button#api-query-add":"addNewItem","click button#api-query-run":"runApiQuery","submit form":"loadApiQuery"},addNewItem:function(e){return this.trigger("add-new-item",this),!1},loadApiQuery:function(t){var i=this.$el.find("input#api-query-input").val();return i&&e.isString(i)&&i.trim().length>0&&this.trigger("load-api-query",i),!1},runApiQuery:function(t){var i=new r;return e.map(this.collection.models,function(e){var t=e.attributes;t.key&&i.set(t.key,t.value.split("|"))}),this.$el.find("#api-query-result").text(i.url()),this.trigger("run-api-query",i),!1},updateInputBox:function(e){this.$el.find("input#api-query-input").val(e)},removeKey:function(e){this.trigger("remove-key",e)}}),p=n.Controller.extend({initialize:function(e){return e&&e instanceof r||(e=new r),this.collection=new d(this.getData(e)),this.view=new h({collection:this.collection,model:new s({initialValue:e.url()||"q=planet"})}),this.listenTo(this.view,"all",this.onAll),this},render:function(){return this.view.render(),this.view},onLoad:function(e){this.collection?this.collection.reset(this.getData(e)):this.initialize(e)},onAll:function(){var e=arguments[0];"childview:remove-clicked"==e?arguments[2].destroy():"childview:key-changed"==e?arguments[2].set("key",arguments[3]):"childview:value-changed"==e?arguments[2].set("value",arguments[3]):"add-new-item"==e?arguments[1].collection.add({key:"",value:""}):"load-api-query"==e?this.onLoad(arguments[1]):"run-api-query"==e&&(this.view.updateInputBox(arguments[1].url()),this.onRun(arguments[1]))},getData:function(t){if(!t)throw Error("Wrong input!");return e.isString(t)&&(t=(new r).load(t)),e.map(t.pairs(),function(e){return{key:e[0],value:e[1].join("|")}})},activate:function(t){this.setBeeHive(t),this.getPubSub().subscribe("all",e.bind(this.onAllPubSub,this))},onAllPubSub:function(){var e=arguments[0];e!=u.START_SEARCH&&e!=u.INVITING_REQUEST||(console.log("[debug:ApiQueryWidget]",arguments[0]),this.view.updateInputBox(arguments[1].url()))},onRun:function(e){this.hasPubSub()&&this.getPubSub().publish(this.getPubSub().START_SEARCH,e)}});return e.extend(p.prototype,l.BeeHive),p});